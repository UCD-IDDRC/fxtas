### Results for latent subtypes analysis {#sec-latent-subtypes .appendix}

```{r}
#| label: set-optimal-subtypes
n_s = n_s_optimal = 6

results_cv_max = extract_results_from_pickle(
  n_s = n_s,
  dataset_name = dataset_name,
  output_folder = output_folder)
```

Based on the CVIC criterion (@sec-cvic), it appears that `r n_s` subtypes is the optimal number for the full, unstratified dataset.
@fig-pvd_optimal shows positional variance diagrams (PVDs) for each of the subtype clusters detected under this assumption, and @tbl-sg_demos shows the demographics of the patients clustered in each subtype. Patients in the "Type 0" category were too early in the disease process to be classified into a subtype.

```{r}
#| label: extract-PVD-optimal
figs = extract_figs_from_pickle(size.y = size.y,
  n_s = n_s,
  dataset_name = dataset_name,
  output_folder = output_folder)
```

::: landscape

```{r}
#| label: "fig-pvd_optimal"
#| layout-ncol: 2
#| fig-height: !expr pvd_height
#| fig-cap: !expr glue::glue("positional variance diagrams for {n_s_optimal} subtypes")
#| fig-cap-location: top
#| column: page
#| fig-subcap:
#|   - "Subtype 1"
#|   - "Subtype 2"
#|   - "Subtype 3"
#|   - "Subtype 4"
#|   - "Subtype 5"
#|   - "Subtype 6"
library(ggplot2)

figs |> print_PVDs()

```

```{r}
#| tbl-cap: !expr glue::glue("Subtype demographics ({n_s} subtypes)")
#| label: tbl-sg_demos
#| results: asis

table_subtype_by_demographics(
  patient_data,
  subtype_and_stage_table = 
    results_cv_max$subtype_and_stage_table
)

```

:::

```{r}
#| label: fig-stage-by-age
#| fig-cap: "Estimated progression stage by age and latent subtype"
#| include: true

stages = 
  results_cv_max$subtype_and_stage_table |> 
  mutate(
    age = patient_data$`Age at visit`,
    id = patient_data$`FXS ID`
  )

library(ggplot2)
stages |>
  graph_stage_by_age()
  


```


