---
title: "Development and progression of 
Fragile X-associated tremor/ataxia syndrome 
revealed by Subtype and Stage Inference analysis"
reference-doc: ../Brain_template_2022.docx
---

```{=html}
<style>
.quarto-figure-center > figure {
text-align: center;
}
</style>
```

```{r}
#| include: false
#| label: setup
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  include = TRUE
)
pander::panderOptions("table.split.table", Inf)
ggplot2::theme_set(ggplot2::theme_bw())
```

```{r}
#| label: libraries
#| message: false
library(fxtas)
reticulate::use_condaenv("fxtas39", required = TRUE)
library(tidyverse)
library(reticulate)
library(pander)
library(table1)
library(magrittr)
library(knitr)
```


```{r}
#| label: "set run parameters"

max_prob_correct = .95

fit_models <- TRUE
run_cv <- TRUE

rerun  <- TRUE
rerun <- FALSE

plot_python <- TRUE
fig_size = c(20, 10)

pvd_height = 10
pvd_width = 8
pvd_line_height = 10
pvd_line_width = 8
size.y = 11
N_startpoints = 10L
# use_parallel_startpoints = TRUE
use_parallel_startpoints = FALSE # couldn't get parallel to work, 2024/06/15
N_S_max = 8L
N_S_max_stratified = 2L
N_CV_folds = 10L

n_permutations = 1000

outcomes_name = "symptom"
events_name = "symptomatic events"
outcomes_name_sentence_start = stringr::str_to_sentence(outcomes_name)

compact_fig_caption <- paste(
  "Positional variance diagrams of estimated event sequences models and uncertainty.",
  "Color intensity represents the likelihood of sequence position.",
  "The brighter the color, the more likely that the corresponding",
  outcomes_name,
  "event occurs in that position in the sequence."
)

compact_fig_cap2 = glue::glue(
  "Red lines indicate biomarkers that moved to later positions between the ",
  "left-hand subgroup and the right-hand subgroup. Blue lines indicate ",
  "{outcomes_name}s that moved to earlier positions. ",
  "Line opacity levels indicate the number of positions changed ",
  "(more opaque = more change.)"
)

# column_var = "Recruited in study phase"
# column_var = "FX3*"
column_var = c("Gender", "FX3*")

N_iterations_MCMC = 1e5L
dataset_name = 'sample_data'
root_dir = here::here()
setwd(root_dir)
output_folder =
  "output/output.fixed_CV/" |>
  fs::dir_create()


```

```{r}
#| label: subset-data

full_data = trax_gp34_v1
n_missing_CGG = full_data$CGG |> is.na() |> sum()
n_above_200 = sum(full_data$CGG >= 200, na.rm = TRUE)
v1_usable = full_data |> filter(CGG < 200) |>
  mutate(`FX3*` = `FX3*` |> droplevels())
v1_usable_males = v1_usable |> filter(Gender == "Male")
v1_usable_females = v1_usable |> filter(Gender == "Female")
v1_usable_cases = v1_usable |> filter(CGG >= 55)

# note: there are 231 records in `visit1` with CGG >= 55, but 4 have CGG >= 200
# previously `nrow(v1_usable_cases)` was 221, which was based on incorrectly filtering on a version of CGG that hadn't been backfilled.

controls_v1 =  v1_usable |> dplyr::filter(CGG < 55)
year_range = v1_usable$`Visit Date` |> year() |> range()
min_year = min(year_range)
max_year = max(year_range)

control_data = controls_v1
patient_data = v1_usable_cases

```

```{r}
#| label: "biomarker-events"
biomarker_groups = compile_biomarker_groups_table()

biomarker_varnames = 
  biomarker_groups |> 
  pull("biomarker")

biomarker_levels = 
  v1_usable |> 
  dplyr::select(all_of(biomarker_varnames)) |> 
  lapply(F = levels)

biomarker_events_table =
  construct_biomarker_events_table(
    biomarker_levels,
    biomarker_groups = biomarker_groups)

nlevs = 
  biomarker_levels |> sapply(length)

```

[Target journal: 
[Brain (Original Articles)](https://academic.oup.com/brain/pages/general_instructions).
Word limit for main text: 6000.
Display items: 8.]{.mark}

{{< pagebreak >}}

# Abstract {.unnumbered}

[Abstract word limit: 400]{.mark}

{{< include _sec_abstract.qmd >}}

{{< pagebreak >}}

# Introduction

{{< include _sec_intro.qmd >}}

# Materials and methods

## Data

### Study cohorts

{{< include _sec_study_cohorts.qmd >}}

The primary sequence analysis of symptomatic evens included baseline visit data 
from `r nrow(v1_usable)` participant
s from the GP and TRAX cohorts,
consisting of 
`r nrow(v1_usable_cases)` fragile X premutation carriers and 
`r nrow(controls_v1)` controls. 
@tbl-demographics provides demographic information about the study participants.
The controls' data are used to estimate 
the distribution of the analyzed `r outcomes_name`s among non-FXTAS individuals 
as reference in SuStaIn modeling
(more details in @sec-scored-events-model).
Then, the cases' data are  used to estimate FXTAS event sequences,
using the estimated control distributions to account for random variation
in observed symptoms unrelated to the underlying event sequence.

### `r outcomes_name_sentence_start`s of neurodegenerative events

We analyzed measurements of 
`r length(biomarker_levels)` ordinal `r outcomes_name`s
with a total of `r sum(nlevs)` levels, 
listed in @tbl-biomarker-list.
Herein the term "`r outcomes_name`s" refers to 
a broad range of medical signs 
or indications of medical state 
observed from patients.
Each "clinically elevated" ordinal level 
(above the first-listed, reference level) 
constitutes an outcome event 
in the disease progression modelling analysis 
(@sec-Statistical-analysis).

We created a composite variable "any autoimmune disorder" combining
lupus, rheumatoid arthritis, 
multiple sclerosis, ANA positivity, Sjogren's syndrome, Raynaud's syndrome, 
and pulmonary fibrosis, 
since these conditions were too rare to analyze separately
(details in Supplementary Materials, @sec-any-autoimmune).
We also created composite variables for 
four domains of the Structured Clinical Interview for DSM-IV (SCID-IV):
Mood Disorders, 
Substance Use Disorders, 
Anxiety Disorders, and 
Somatoform Disorders;
there were no participants with Psychotic Disorders in our data
(more details in Supplementary Materials, @sec-scid-composites).
We used the "Lifetime" variables from SCID-IV to construct these composites.
We also created composite variables for 
MRI variables for cerebral and cerebellar abnormalities detected via MRI;
we did not combine the variables representing corpus callosum MRI abnormalities,
since these variables were created using Likert scales that differed from each other
(details in Supplementary Materials, @sec-mri-composites).

[Supplemental Tables @tbl-tremors] - [-@tbl-autoimmune] 
summarize each of the `r outcomes_name`s that we included in the analysis models, 
stratified by 
CGG repeat size (`r levels(v1_usable$"FX3*")`) 
and 
Sex (`r unique(v1_usable$Gender)`).

## Statistical analysis {#sec-Statistical-analysis}

### Ordinal SuStaIn model {#sec-scored-events-model}

We applied a discrete event-based disease progression model 
[@fonteijn2011event; @fonteijn2012event; @oxtoby2023data] 
to our data using the Ordinal Subtype and Stage Inference ("SuStaIn") algorithm 
[@young2021ordinal] 
to estimate event orderings and subtypes for FXTAS patients. 
SuStaIn is a data-driven statistical modeling algorithm 
that combines 
event-based disease progression modelling 
[@fonteijn2011event; @fonteijn2012event; @oxtoby2023data]
and latent-cluster finite mixture modeling 
[@pearson1894contributions; @lazarsfeld1950logical; @mclachlan2019finite] 
to model event sequences 
using cross-sectional samples of patient and control populations. 
The algorithm simultaneously 
clusters individuals into latent subtypes and 
characterizes the event ordering that best defines each subtype, 
thus capturing heterogeneity in both disease subtype and disease stage.

Ordinal SuStaIn [@young2021ordinal] is 
a version of the SuStaIn modeling algorithm [@young2018uncovering],
adapted for analyzing ordinal-valued data using a scored events model.
Ordinal SuStaIn uses a "scored events model", 
which assumes that for each `r outcomes_name`,
there is a discrete set of 
underlying ordinal severity levels,
but the measured versions of the `r outcomes_name`s may contain 
some amount of random noise.
For example, an individual who is really at Ataxia Severity level 2 may be 
incorrectly assessed as being at Ataxia Severity level 1, depending on
the patient's temporary disease status on the day of the exam or
inter-rater differences.
The first step in applying the Ordinal SuStaIn algorithm is to determine,
for each `r outcomes_name`, the probability that an individual is 
"correctly scored" at their "true underlying level" [@young2021ordinal].
In this analysis, we assumed that all controls are truly at the reference levels
for each `r outcomes_name`, 
and we estimated the proportion of correctly scored individuals as
the proportion of controls 
who were assessed as being at the reference level
[Supplementary Materials, @tbl-prob-correct].
It is crucial to allow some possibility of incorrect scoring, 
so we capped the estimated correct scoring probabilities at 
`r max_prob_correct *100`%.
Ordinal SuStaIn then uses 
Markov Chain Monte Carlo (MCMC) sampling [@gelfand1990sampling]
to estimate the Bayesian posterior probability of each possible event sequence 
for each subtype given the training dataset, 
assuming a uniform prior distribution 
over the set of all possible orderings. 
We conducted subgroup analyses by fitting models stratified by
sex (@sec-methods-strat-sex), CGG repeats (<100 vs ≥100) 
(Supplementary Materials, @sec-methods-strat-cgg),
and combinations of sex and CGG repeats (<100 vs ≥100) 
(Supplementary Materials, @sec-stratified-by-cgg-and-sex).
In these subgroup analyses, we did not search for latent clusters.

### Imputation of missing data {#sec-incomplete-data}

```{r}
#| label: count-incomplete-data
x1 = v1_usable_cases |> pull(`Ataxia: severity`)
n_missing = sum(x1 |> is.na())
# n_obs = sum(x1 |> is.na() |> not()) # not() is deprecated?
n_obs = sum(!is.na(x1)) 
n_total = length(x1)
pct_missing = scales::percent(n_missing / n_total, accuracy = 0.1)
pct_obs = scales::percent(n_obs / n_total, accuracy = 0.1)
probs = 
  x1 |> 
  table() |> 
  proportions() |> 
  as.vector() |> 
  scales::percent(accuracy = 0.1)
  
```

We assumed that missing `r outcomes_name` data 
were missing at random (MAR) 
[@rubin1976inference, @little2019statistical].
As the longitudinal cohorts have evolved over several funding cycles,
new instruments were adopted and added; 
much of the missingness was due to 
adding additional measures in later cycles of the studies. 
The MAR assumption thus seems plausible.
We substituted missing outcome event data 
by assigning a probability distribution across the 
possible values of the missing variable 
that matched the marginal distribution of observed data 
among the cases. 
For example, 
`r n_missing` of the `r length(x1)` cases (`r pct_missing`) 
had missing values for Ataxia Severity, 
and `r n_obs` (`r pct_obs`) had recorded values, 
distributed among Ataxia Severity levels 0-4
(`r v1_usable_cases$"Ataxia: severity*" |> counts_and_pcts() |> and::and()`,
respectively).
For the `r n_missing` cases with missing values, 
we assigned probabilities of `r probs |> and::and()` 
to Ataxia Severity levels `r 0:4 |> and::and()`, respectively, 
and missing values were imputed under the marginal distribution
of the observed data.

### Statistical hypothesis tests

To test for statistical significant evidence of differences 
in event sequences
between males and females
and between lower (CGG <100) 
and higher premutation levels (CGG 100-199),
we implemented a permutation test [@welch1990construction]
to calculate a p-value that is 
the probability of observing a difference 
at least as extreme as the test statistic 
given that the null hypothesis of no difference is true.
We first created `r n_permutations` permuted datasets 
in which we randomly shuffled the variable being tested.
We computed the mean log-likelihood of the data 
for each permuted dataset 
(averaging across MCMC samples and 
summing across the strata being compared) 
and compared 
the distribution of permuted mean log-likelihoods 
to the observed log-likelihood 
calculated from the original (unpermuted) dataset.
We computed the empirical p-value 
by first computing the percentile of 
the observed mean log-likelihood 
relative to the empirical distribution of 
the permuted mean log-likelihoods,
subtracting that percentile from 1 if larger than 0.5,
and then multiplying by two to calculate a two-sided test statistic.
We declared significance if the p-value was less than or equal to 0.05.
A detailed numerical example of this procedure 
is provided in the Supplementary Materials (@sec-permutation-test).

### Latent subtype clustering {#sec-methods-latent-subtypes}

We also fitted the model on the full dataset (not stratified by sex or CGG) 
for 2 - `r N_S_max` latent subtypes, 
each with their own ordering. 
We determined the optimal number of latent subtypes for this dataset using 
the Cross-Validation Information Criterion (CVIC)
and the Out-Of-Fold Log-Likelihood (OOFLL) criterion [@young2018uncovering];
both criteria quantify how well models containing a given number of subtypes
extend to new data not used in training.
We performed `r N_CV_folds` - fold cross-validation on the unstratified data
and calculated the CVIC and OOFLL for 1-`r N_S_max` latent subtypes. 
More details are provided in the Supplementary Materials (@sec-subtypes).

<!-- {{< include _methods_longitudinal.qmd >}} -->

### Visualizing modeling results

We visualized the results of Ordinal SuStaIn analysis 
using "positional variance diagrams" (PVDs).
PVDs are heatmaps with `r events_name` on the y-axis 
and sequence positions of events on the x-axis.
Each event is estimated to occur at some point in continuing time 
*relative to* other events in sequence.
It should be noted that the exact onset time of each event
cannot be determined by the method we used for this analysis.
The PVD's color scale indicates the Bayesian posterior probability that 
a particular event (y-axis) 
appears at a particular position along the progression sequence (x-axis). 
Color intensity presents the likelihood of sequence position. 
That is, a brighter color indicates a more probable sequence position, 
and a paler color indicates a less probable position. 
The colors indicate the ordinal levels of progression.

## Software

The Ordinal Sustain analysis was performed using 
the Python programming language, version 3.9 [@python3] 
with the `pySuStaIn` package [@aksman2021pysustain].
Data pre-processing and results post-processing were performed in 
R 4.4.0 [@rcore] using the `tidyverse` packages [@tidyverse].
The `reticulate` package [@reticulate] was used to create 
an application programming interface between Python and R.
The code used to perform this analysis is available at 
<https://github.com/d-morrison/fxtas>.

# Results

```{r}
#| label: get-control-dists

prob_correct = 
  control_data |> 
  compute_prob_correct(
    max_prob = max_prob_correct,
    biomarker_levels = biomarker_levels)

```

```{r}
#| message: false
#| label: model-all-subgroups-first-visits
#| include: false
#| eval: !expr fit_models

sustain_output = run_and_save_OSA(
  biomarker_levels = biomarker_levels, 
  prob_correct = prob_correct, 
  SuStaInLabels = biomarker_varnames,
  N_startpoints = N_startpoints,
  N_S_max = N_S_max, 
  N_iterations_MCMC = N_iterations_MCMC, 
  output_folder = output_folder, 
  dataset_name = dataset_name, 
  use_parallel_startpoints = use_parallel_startpoints,
  seed = 1,
  plot = plot_python,
  rerun = rerun,
  patient_data = patient_data,
  N_CV_folds = N_CV_folds)

```

```{r}
#| message: false
#| label: model-males-v1
#| include: false
#| eval: !expr fit_models

sustain_output_males = run_and_save_OSA(
  patient_data = patient_data |> filter(Gender == "Male"),
  prob_correct = prob_correct,
  biomarker_levels = biomarker_levels,
  SuStaInLabels = biomarker_varnames,
  N_startpoints = N_startpoints,
  N_S_max = N_S_max_stratified,
  N_iterations_MCMC = N_iterations_MCMC,
  output_folder = output_folder,
  dataset_name = "males",
  use_parallel_startpoints = use_parallel_startpoints,
  seed = 1,
  plot = plot_python,
  rerun = rerun,
  fig_size = fig_size)

```


```{r}
#| message: false
#| label: model-females
#| include: false
#| eval: !expr fit_models

sustain_output_females = run_and_save_OSA(
  biomarker_levels = biomarker_levels, 
  prob_correct = prob_correct, 
  patient_data = patient_data |> filter(Gender == "Female"),
  
  SuStaInLabels = biomarker_varnames,
  N_startpoints = N_startpoints,
  N_S_max = N_S_max_stratified, 
  N_iterations_MCMC = N_iterations_MCMC, 
  output_folder = output_folder, 
  dataset_name = "females", 
  use_parallel_startpoints = use_parallel_startpoints,
  seed = 1,
  plot = plot_python,
  rerun = rerun,
  fig_size = fig_size)

```

```{r}
#| label: extract-figs

results_v1 = extract_results_from_pickles(
  n_s = 1:N_S_max,
  rda_filename = "data.RData",
  dataset_name = "sample_data",
  output_folder = "output/output.fixed_CV")

fig_females_first = extract_figs_from_pickle(
  size.y = size.y,
  n_s = 1,
  rda_filename = "data.RData",
  dataset_name = "females",
  output_folder = "output/output.fixed_CV")

fig_males_first = extract_figs_from_pickle(
  size.y = size.y,
  n_s = 1,
  rda_filename = "data.RData",
  dataset_name = "males",
  output_folder = "output/output.fixed_CV")

fig_both_first = extract_figs_from_pickle(
  size.y = size.y,
  n_s = 1,
  rda_filename = "data.RData",
  dataset_name = "sample_data",
  output_folder = "output/output.fixed_CV")

fig_under100 = extract_figs_from_pickle(
  size.y = size.y,
  n_s = 1,
  dataset_name = "under100",
  output_folder = output_folder)

fig_over100 = extract_figs_from_pickle(
  size.y = size.y,
  n_s = 1,
  dataset_name = "over100",
  output_folder = output_folder)

fig_under100_males = extract_figs_from_pickle(
  size.y = size.y,
  n_s = 1,
  dataset_name = "under100_Male",
  output_folder = output_folder)

fig_over100_males = extract_figs_from_pickle(
  size.y = size.y,
  n_s = 1,
  dataset_name = "over100_Male",
  output_folder = output_folder)


fig_under100_females = extract_figs_from_pickle(
  size.y = size.y,
  n_s = 1,
  dataset_name = "under100_Female",
  output_folder = output_folder)

fig_over100_females = extract_figs_from_pickle(
  size.y = size.y,
  n_s = 1,
  dataset_name = "over100_Female",
  output_folder = output_folder)

```

```{r}
#| label: basic-summary-stats
stages = v1_usable_cases |> select(`FXTAS Stage (0-5)*`) |> table()
biomarkers_table = 
  v1_usable |> 
  make_biomarkers_table(
    biomarker_varnames = biomarker_varnames,
    biomarker_events_table = biomarker_events_table)
```

@tbl-demographics describes summary statistics of patient characteristics 
included in the analysis. 
Our data included: 
`r nrow(v1_usable_cases)` Fragile X premutation carriers and 
`r nrow(controls_v1)` controls;
`r nrow(v1_usable_males)` males and `r nrow(v1_usable_females)` females;
and `r and::and(stages)` carriers at 
FXTAS stages `r names(stages) |> and::and()`, respectively. 
We found no differences between males and females in 
age at baseline visit, 
ethnicity/race, 
FXTAS stage, or
CGG repeat size.
@tbl-biomarker-list lists the `r outcomes_name`s and their ordinal levels
and reports proportions of clinically elevated levels at baseline visit, 
stratified by sex.
We found significant sex differences in 
proportions of clinically elevated (non-reference) `r outcomes_name` levels 
at baseline visit for `r report_sex_differences(biomarkers_table)`.

## Sex differences in sequential orders {#sec-methods-strat-sex}

```{r}
#| label: p-val-test-sex
output_folder = "output/output.fixed_CV/"

permuted_test_stats = collect_permutation_test_stats(
  output_folder = output_folder,
  permuting_variables = "Gender")

observed_test_stat = get_observed_permutation_test_stat(
  output_folder,
  dataset_names = c('females', 'males'))

pval_sex_gp34_v1 = permutation_test(
  observed_test_stat = observed_test_stat,
  permuted_test_stats = permuted_test_stats,
  n_permutations = n_permutations
)

```

@fig-first-only shows 
the estimated sequential orders
of FXTAS `r outcomes_name`s 
in males and females.
We found statistically significant evidence of a 
difference in sequences of `r events_name`
between males and females (p = `r pval_sex_gp34_v1`) 
(@fig-first-only-1 and [(b)](#fig-first-only-2)). 
It appears that 
female premutation carriers developed 
SCID Mood Disorder symptoms, 
both sub-threshold-level and threshold-level,
prior to FXTAS Stage 1 diagnosis,
whereas male carriers delayed these symptoms 
much later between FXTAS Stages 3 and 4 (@fig-first-only-2).
Cognitive decline, as measured by SWM and PAL,
also occurred at earlier FXTAS stages for females.
Ataxia occurred prior to Stage 1 for females 
and after Stage 2 for males.
However, ataxia severity level 1 occurred 
earlier for males (between Stages 2-3) 
than for females (between Stages 3-4).
Advanced degrees of ataxia severity also occurred 
earlier in the event sequence for males than females. 
MRI biomarkers of decline and parkinsonian features 
also appear to onset at earlier FXTAS stages for males than for females.


```{r}
#| label: p-val-test-sex-under100
output_folder = "output/output.fixed_CV/"

permuted_test_stats = collect_permutation_test_stats(
  output_folder = output_folder,
  stratifying_levels = "CGG 55-99",
  permuting_variables = "Gender")

observed_test_stat = get_observed_permutation_test_stat(
  output_folder,
  dataset_names = c('under100_Female', 'under100_Male'))

pval_under100_sex_gp34_v1 = permutation_test(
  observed_test_stat = observed_test_stat,
  permuted_test_stats = permuted_test_stats,
  n_permutations = n_permutations
)

```

```{r}
#| label: p-val-test-sex-over100
output_folder = "output/output.fixed_CV/"

permuted_test_stats = collect_permutation_test_stats(
  output_folder = output_folder,
  stratifying_levels = "CGG 100-199",
  permuting_variables = "Gender")

observed_test_stat = get_observed_permutation_test_stat(
  output_folder,
  dataset_names = c('over100_Female', 'over100_Male'))

pval_over100_sex_gp34_v1 = permutation_test(
  observed_test_stat = observed_test_stat,
  permuted_test_stats = permuted_test_stats,
  n_permutations = n_permutations
)

```

When we conducted subgroup analyses by CGG repeat size,
we found statistically significant evidence of 
a difference between males and females
among those with CGG < 100 (p = `r pval_under100_sex_gp34_v1`)
(Supplementary @fig-pvd-by-gender-cgg_under100).
Several psychiatric disorders (as measured by SCID) 
occurred prior to FXTAS Stage 1
among females with CGG < 100,
but at later FXTAS stages for males with CGG < 100.
MRI biomarkers appeared to occur at later stages in females compared to males.
We did not find statistically significant evidence of 
a difference between males and females
among those with CGG ≥ 100 (p = `r pval_over100_sex_gp34_v1`) 
(Supplementary Materials, @fig-pvd-by-gender-cgg_over100).


```{r}
#| label: p-val-test-cgg-male
output_folder = "output/output.fixed_CV/"

permuted_test_stats = collect_permutation_test_stats(
  output_folder = output_folder,
  stratifying_levels = "Male",
  permuting_variables = "FX3")

observed_test_stat = get_observed_permutation_test_stat(
  output_folder,
  dataset_names = c('under100_Male', 'over100_Male'))

pval_male_cgg_gp34_v1 = permutation_test(
  observed_test_stat = observed_test_stat,
  permuted_test_stats = permuted_test_stats,
  n_permutations = n_permutations
)

```


```{r}
#| label: p-val-test-cgg-female
output_folder = "output/output.fixed_CV/"

permuted_test_stats = collect_permutation_test_stats(
  output_folder = output_folder,
  stratifying_levels = "Female",
  permuting_variables = "FX3")

observed_test_stat = get_observed_permutation_test_stat(
  output_folder,
  dataset_names = c('under100_Female', 'over100_Female'))

pval_female_cgg_gp34_v1 = permutation_test(
  observed_test_stat = observed_test_stat,
  permuted_test_stats = permuted_test_stats,
  n_permutations = n_permutations
)

n_over100_Female =
  v1_usable |>
  filter(
   Gender == "Female",
   CGG >= 100
  ) |>
  nrow()

```

We found significant evidence of an overall difference between CGG <100
and CGG ≥100 among males (p = `r pval_male_cgg_gp34_v1`) 
(Supplementary Materials, @fig-pvd-by-cgg-male). 
SWM between errors occurred prior to Stage 1 in males with CGG repeats <100, 
whereas it occurred between stage 3 and 4 
in males with CGG repeats ≥ 100 
(@fig-pvd-by-cgg-male-2). 
Postural, 
resting, 
and intermittent tremor 
occurred in earlier FXTAS stages in those with CGG repeats <100 
compared to those with CGG repeats ≥100.
Several psychiatric disorders (as measured by SCID) 
occurred later in the event sequence in participants with CGG repeats <100 
compared to those with CGG repeats ≥100.  
However, we did not find a significant difference between CGG <100 and CGG ≥100 
among females (p = `r pval_female_cgg_gp34_v1`) 
(Supplementary Materials, @fig-pvd-by-cgg-female). 
It should be noted that this comparison lacked statistical power 
given the limited sample size of only `r n_over100_Female` females with CGG ≥100.

## Subtype clustering

```{r}
#| label: set-optimal-subtypes
temp = sustain_output |> attr("CV")
n_s_min_CVIC = which.min(temp$CVIC)
n_s_selected = 4

results_cv_max = extract_results_from_pickle(
  n_s = n_s_selected,
  dataset_name = dataset_name,
  output_folder = output_folder)
```

We conducted latent subtype classification analysis to cluster participants 
that are relatively homogeneous within the same cluster 
and heterogeneous from other clusters 
based on similarities and difference in sequential patterns. 
Based on the CVIC criterion (Supplementary Materials, @sec-subtypes), 
`r n_s_min_CVIC` subtypes were suggested to be the optimal number for the full, 
unstratified dataset (Supplementary Materials, @fig-cvic-1). 
The out-of-fold log-likelihood ("OOFLL") (Supplementary Materials, @sec-subtypes) 
showed substantial fold-to-fold variation (Supplementary Materials, @fig-cvic-2).
Between `r broman::spell_out(n_s_selected)` and `r broman::spell_out(N_S_max)` 
latent subgroups, 
the distribution of OOFLL appears to be
approximately unchanging and the CVIC appears approximately flat, 
and thus for easier clinical interpretation, 
we chose to classify participants into `r n_s_selected` subtypes.
The subtypes are numbered 1-4 in order of estimated relative frequency
(that is, in order of how many participants were clustered into each subtype).

```{r}
n_type_0 = results_cv_max$subtype_and_stage_table |> 
  filter(ml_subtype == "Type 0") |> 
  nrow()

```

@fig-pvd_chosen_subtypes shows the estimated sequential event orders
for each of the subtype clusters 
and differences in event sequences between subtypes. 
@tbl-sg_demos shows the demographics of the patients clustered in each subtype. 
`r n_type_0` patients had experienced too few events 
to be accurately classified into a subtype and were excluded from @tbl-sg_demos.

Subtype clustering analysis showed that 
subtypes were mainly classified by sex and CGG repeat size, 
supporting the results above. 
Subtype 1 appeared more biased towards males (65.01%) 
and lower CGG repeat size (83.2 ± 15.8) 
compared to the overall study population 
(64.5% of males; CGG repeat size = 87.3  ± 18.9) and other subtypes; 
Subtype 2 appeared biased towards females (53.12% of males) 
and higher CGG repeat size (90.2 ± 22.3); 
Subtype 3 appeared over-represented by males (82% of males) 
and high CGG repeat size (92.4 ± 17.4); 
and Subtype 4 was biased towards females (60% of males) 
and lower CGG repeat (82.7 ± 17.3). 

```{r}
n_events = nrow(biomarker_events_table)
```

With `r n_events` symptoms included in the analysis, 
it is challenging to concisely summarize the differences between subtypes, 
especially given the relatively small sample sizes per subtype 
and the correspondingly large amounts of uncertainty in their event orderings.
In this analysis approach, 
the event onsets are not modeled as a function of participant age;
instead, each event's onset timing is only modeled relative to the other events.
Therefore, the sequence differences between the subtypes are all in relative terms: 
if one event moves earlier in the sequence when comparing one subtype to another, 
other events are pushed later in the sequence, 
even if only one event timing
changes relative to age.
In order to provide clearer clinical interpretation, 
we used the FXTAS Stage transitions as reference points,
and examined the differences in onsets 
relative to these FXTAS Stage transitions.
Roughly speaking:
Subtype 1 appeared to experience 
early mood disorders (before FXTAS Stage 1),
ataxia between Stages 2 and 3,
head tremors between Stages 3 and 4,
parkinsonian features between Stages 3 and 4,
and white matter disease phenotypes between Stages 4 and 5.
Compared to Subtype 1, Subtype 2 appeared to experience 
white matter disease phenotypes earlier (between Stages 2 and 4),
memory issues (assessed by SWM) earlier (Stage 3-4 versus 4-5).
and SCID disorders later (between Stages 3 and 5).
Subtype 2 might be described as "memory-first".
Subtype 3 appeared to experience
white matter disease phenotypes early (between Stages 1 and 3),
and mood disorders late (Stages 4-5).
Subtype 4 had the fewest participants and was difficult to interpret.
It may represent a mixture of smaller latent subtypes and/or
include outlier individuals with unusual event sequences.

# Discussion

## Main findings

The main findings of this analysis were substantial differences in order of onset
between males and females,
and the presence of at least four latent subgroups.

## Clinical interpretation

The proportions of 
lifetime anxiety disorders, 
mood disorders, 
and somatoform disorders in this study cohort
is far more than 
[Clinicians: please provide a reference for comparison]{.comment-start}
usual population expectations for these illnesses 
[]{.comment-end}. 
This study design did not fractionate specific lifetime psychiatric illnesses
(e.g., major depressive disorder, panic disorder, and somatization disorder),
but these overall lifetime prevalence figures are notable.
[Clinicians: please provide a reference]{.comment-start}
Prior studies of mood and anxiety disorders
[]{.comment-end}
have demonstrated a higher than expected rate of these illnesses 
in premutation carriers. 
The same increase lifetime psychiatric illness burden 
[Clinicians: please provide a reference]{.comment-start}
is seen in other neurodegenerative illnesses 
(e.g., Parkinson’s disease, multiple sclerosis).
[]{.comment-end}
While many psychiatric illness have a strong genetic predisposition, 
the lifetime prevalences here persuasively suggest that 
the premutation carrier state itself increases the risk of psychiatric illness. 
As the SCID assesses lifetime illness risk, 
it is probable that the index episode of psychiatric illness 
antedated the onset of 
tremor, 
ataxia, and 
major neurocognitive disorder 
seen in more advanced premutation conditions like FXTAS. 
As such, the high lifetime burden of psychiatric illness in this population 
cannot be plausible attributed solely (perhaps substantially) to 
an “emotional reaction” 
to the loss of function associated with these functional impairments,
but rather should be understood as a component of the premutation carrier state itself. 
It is likely that this intrinsic vulnerability to psychiatric illness 
is a significant component of the carrier state. 
Furthermore, as only a small proportion of the patients 
had MMSE scores in the impaired range, 
it is also unlikely that the high rates of 
depressive, anxiety (and other) psychiatric illness 
could be attributed to complications of FXTAS dementia, 
as the majority of subjects had normal MMSE scores, 
which would not be consistent with dementia. 
For example, depressive disorders 
are a common psychiatric complication of dementia, 
but few of the depressive disorders found here could be attributed to dementia. 
A common sequence of illnesses seen clinically in carriers is 
depressive and/or anxiety disorders with adult onset, 
then tremor and ataxia in the 40s, 
followed by FXTAS dementia in the 60s. 
Seen in this light, and knowing the ultimate CNS vulnerability of the carrier state, 
retrospectively the initial presentation of depressive and/or anxiety disorders 
could be regarded as a psychiatric prodrome of later full spectrum illness. 
This is analogous to the psychotic illness seen in SLE before rheumatologic findings 
and the depressive disorder that is commonly seen 
in the 5 years before the motor signs leading to a diagnosis of multiple sclerosis. 

This data shows more significant involvement in males than females, as predicted,
but a remarkable finding is the predominance of the psychiatric problems 
that occur early in females 
and often before the onset of tremor and ataxia compared to the males.
These symptoms, particularly mood disorders, 
can often occur even before the diagnosis of FXTAS in the females,
and the stress involved with mood disorders may be a precipitating feature 
for the onset of FXTAS.
In addition, females may exerience early cognitive problems,
particularly involving executive dysfunction and memory,
as seen by the SWM and PAL scores that occur early on in the females.
From a clinical perspective,
we have seen significant psychiatric problems 
leading into some cognitive deficits in memory and EF abilities, 
but these females may not meet the criteria of FXTAS diagnosis, 
because of the absence of significant tremor and/or ataxia. 
However, if white matter disease emerges on MRI particularly in the splenium 
or in the periventricular area,
then this demonstrates the onset of the neuropathology of FXTAS, 
even if there is no tremor or ataxia yet. 
This suggests that the diagnostic criteria for FXTAS 
is different in females compared to males,
particularly for early cases.
The diagnostic criteria for FXTAS was determined with the study of males only 
[@jacquemont2003fragile]. 
Subsequent criteria for the diagnosis of FXTAS was modified [@hall2014emerging]
to include the involvement of the splenium,
which is seen in the majority of females with FXTAS 
[@apartis2012fxtas; @schneider2020women].
Hall et al [-@hall2014emerging] also added the feature of neuropathy, 
which occurs in the majority of FXTAS patients,
but it is a common finding in the elderly with many causes,
so it is just a minor criteria for FXTAS. 
Although the diagnostic criteria have been modified somewhat for the females,
there may be subsequent changes in the early stages of FXTAS 
as further follow-up studies are able to separate 
the psychiatric problems in females seen early on here 
from more significant neuropathology associated with 
extended features of FXTAS over time.
As new treatments for FXTAS develop, 
the earlier the diagnosis, 
the more likely the treatment will be effective.

## Limitations

### Missing data

We had substantial amounts of missing data. 
As described in the methods (@sec-incomplete-data),
we used the marginal distribution of 
the observed data for each `r outcomes_name` among cases
to impute the underlying values of these missing data. 
The missing data could contribute to uncertainty in the results.

### Discretizing numeric biomarkers

Our data contained both continuous and ordinal variables.
In order to apply the Ordinal SuStaIn algorithm, 
we categorized some `r outcomes_name`s 
that were originally measured as continuous values.
In doing so, we likely sacrificed some granular information. 
There are other variations of the SuStaIn algorithm, 
such as z-score SuStaIn [@young2018uncovering] 
which are designed to be used with only continuous measurements.
Further development is warranted to combine Ordinal SuStaIn and z-score SuStaIn
to fit an event-based model with both continuous and ordinal data. 

### Comparison with longitudinal data

Our data come from the GP and Trax studies, 
which are longitudinal cohort studies
with infrequent followup visits.
These studies do not collect precise information 
about timing of symptom onsets, 
so it is not feasible to use the longitudinal data 
to confirm the results from the Ordinal SuStaIn analysis.
Additional research including longitudinal data 
collecting precise ages of onset 
would be needed to verify our findings.

# Data availability {.unnumbered}

The de-identified data used in this analysis may be provided 
upon request 
from the principal investigators of the two cohorts.

# Funding {.unnumbered}

This study was supported by the 
National Institute of Child Health and Human Development 
(NICHD, grant numbers HD036071 (Hagerman) and P50HD103256 (Abbeduto))
and the National Institute of Neurological Disorders and Stroke 
(NINDS, grant number NS110100 (Rivera)),
through the University of California Davis 
Medical Investigation of Neurodevelopmental Disorder (MIND) Institute’s 
Intellectual and Developmental Disabilities Research Center (IDDRC).

# Competing interests {.unnumbered}

The authors report no competing interests.

# Supplementary material {.unnumbered}

Supplementary material is available at Brain online.

# References {.unnumbered}

::: {#refs}
:::

::: landscape

# Tables {.unnumbered}

```{r}
#| label: "tbl-demographics"
#| tbl-cap: "**Descriptive statistics of patient characteristics by CGG repeat level.** `*`p-values represent tests for sex differences in distributions of characteristics, ignoring CGG repeat level."

v1_usable |> make_demographics_table()

```

{{< pagebreak >}}

```{r}
#| tbl-cap: |
#|    **Symptoms included in analysis.** 
#|    The first level listed in each row of column "Defined Ordered Levels" 
#|    is the "reference level" for the corresponding symptom,
#|    and subsequent levels are considered "clinically elevated levels".
#|    Columns "Female" and "Male" list proportions of clinically elevated levels 
#|    at baseline visit, stratified by sex.
#| label: tbl-biomarker-list

flex_biomarkers_table(biomarkers_table)
```

:::

```{r}
#| tbl-cap: !expr 
#|     glue::glue(
#|        "**Demographics of {n_s_selected} latent subtype clusters 
#|        identified by Ordinal SuStaIn.** 
#|        {n_type_0} patients had experienced too few events 
#|        to be accurately classified into a subtype 
#|        and were excluded from this table.")
#| label: tbl-sg_demos
#| results: asis


set.seed(2)
table_subtype_by_demographics(
  patient_data,
  subtype_and_stage_table = 
    results_cv_max$subtype_and_stage_table
) |>
  gtsummary::separate_p_footnotes() |>
  gtsummary::as_flex_table() |>
  flextable::width(width = 1.75) |>
  flextable::width(j = 2:6, width = 0.75) |>
  flextable::width(j = 7, width = 1)

```

# Figures {.unnumbered}

```{r}
#| label: "fig-first-only"
#| column: page
#| fig-height: !expr pvd_height
#| fig-width: !expr pvd_width
#| fig-cap: !expr 
#|    glue::glue(
#|    "**Event sequence models stratified by sex.** 
#|    **(a)** {compact_fig_caption} 
#|    **(b)** Positional differences in estimated event sequence between sexes. 
#|    {compact_fig_cap2}")
#| layout-ncol: 1
#| fig-subcap: 
#|    - " "
#|    - " "
#| fig-cap-location: top


plot_compact_pvd(
  figs = list(
    fig_males_first,
    fig_females_first
  ),
  facet_label = c("Males <br>", "Females <br>"),
  y_text_size = 11
)

list(
    "Males" = fig_males_first,
    "Females" = fig_females_first
  ) |> 
pvd_lineplot(y_text_size = 11)

```

{{< pagebreak >}}

```{r}
#| label: fig-pvd_chosen_subtypes
#| fig-height: !expr pvd_height
#| fig-width: !expr pvd_width
#| fig-cap: !expr 
#|     glue::glue(
#|     "**Event sequences stratified by sex, 
#|     for {n_s_selected} latent subtypes.**
#|     **(a)** {compact_fig_caption} 
#|     **(b-d)** Differences in event sequences of subtypes 
#|     2-{n_s_selected} compared to subtype 1.") 
#| fig-cap-location: top
#| layout-ncol: 1
#| layout-nrow: 4
#| fig-subcap: 
#|    - "Positional variance diagrams by latent subtype."
#|    - "Subtype 1 compared to Subtype 2"
#|    - "Subtype 1 compared to Subtype 3"
#|    - "Subtype 1 compared to Subtype 4"
#|    - "Subtype 2 compared to Subtype 3"
#|    - "Subtype 2 compared to Subtype 4"
#|    - "Subtype 3 compared to Subtype 4"
#| column: page
#| 
figs = extract_figs_from_pickle(
  size.y = size.y,
  n_s = n_s_selected,
  dataset_name = dataset_name,
  output_folder = output_folder)

library(ggplot2)

plot_compact_pvd(
  figs = figs,
  tile_height = 1,
  facet_label_prefix = NULL,
  y_text_size = 8
)

pvd_lineplot(
  figs = list(
    "Subtype 1" = figs[[1]],
    "Subtype 2" = figs[[2]]
  )
)

pvd_lineplot(
  figs = list(
    figs[[1]],
    figs[[3]]
  ),
  facet_labels = c("Subtype 1", "Subtype 3")
)

pvd_lineplot(
  figs = list(
    figs[[1]],
    figs[[4]]
  ),
  facet_labels = c("Subtype 1", "Subtype 4")
)

pvd_lineplot(
  figs = list(
    figs[[2]],
    figs[[3]]
  ),
  facet_labels = c("Subtype 2", "Subtype 3")
)

pvd_lineplot(
  figs = list(
    figs[[2]],
    figs[[4]]
  ),
  facet_labels = c("Subtype 2", "Subtype 4")
)

pvd_lineplot(
  figs = list(
    figs[[3]],
    figs[[4]]
  ),
  facet_labels = c("Subtype 3", "Subtype 4")
)

```

{{< pagebreak >}}

# Supplementary material {.appendix}

{{< include _sec_supplement.qmd >}}

```{r}
#| label: save-image
fs::path_package("fxtas", "extdata") |> 
  fs::path("ordinal-sustain-results.rda") |> 
  save.image()

# fs::path_package("fxtas", "extdata") |>
#   fs::path("ordinal-sustain-results.rda") |>
#   load()

```
