---
title: "Questions about FXTAS Sequence Data"
format:
  html:
    toc: true
    toc-depth: 4
    toc-float: true
    number-sections: true
  docx:
    number-sections: true
---

```{r, include = FALSE}

knitr::opts_chunk$set(
  collapse = TRUE,
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  comment = "#>",
  fig.width = 7.5,
  fig.height = 4
)

# update 'asis' chunk to allow inline code
knitr::knit_engines$set(asis = function(options) {
  if (options$echo && options$eval) knitr::knit_child(text = options$code)
})
```

```{r setup}
library(fxtas)
devtools::load_all()
library(pander)
library(table1)
library(dplyr)
library(magrittr)
NA.label1 = "Missing"
# column_var = "Recruited in study phase"
column_var = "FX**"
# load_all()

phase <- ifelse(column_var == "Recruited in study phase", TRUE, FALSE)
cgg <- ifelse(column_var == "FX**", TRUE, FALSE)
```

# Data from first visits

```{asis, echo=phase}
Here, we review the data from the first visits by each participant, stratified by 
the first study phase in which the participant enrolled (GP3 vs GP4).
```

```{asis, echo=cgg}
Here, we review the data from the first visits by each participant, stratified by CGG (`r paste0("<55 or", " \u2265", "55")`).
```

## Study

```{r}
table1(
  NA.label = NA.label1,
  formula(paste(
    "~", paste(formulaic::add.backtick("Study"), collapse = " + "), 
    "|",
    column_var |> formulaic::add.backtick())),
  data = visit1)
```

## APOE

```{r}
apoe.n = gp34 |> missing_pattern_by_ID(variable = "ApoE")

```

Many participants (`r sum(apoe.n$first_missing)` of `r nrow(apoe.n)`) have ApoE missing in their first visit records:

```{r}
vars = grep("^ApoE", names(gp34), value = TRUE)
table1(
  NA.label = NA.label1,
  
  paste(
    "~", 
    paste(
      formulaic::add.backtick(vars), 
      collapse = " + "), 
    "|",
    column_var |> formulaic::add.backtick()) |> 
    formula(),
  # render.missing=c("Empty in RedCap"="FREQ (PCT%)"),
  data = visit1)
```


`r apoe.n |> filter(first_missing) |> pull(any_nonmissing) |> sum()` of these individuals have later visits with non-missing ApoE results; for example:

```{r}

gp34 |> filter(
  # `FXS ID` == "500011-122"
  `FXS ID` == apoe.n |> filter(first_missing, any_nonmissing) |> head(1) |> pull(`FXS ID`)
) |> 
  select(`FXS ID`, `Event Name`, `Visit Date`, ApoE) |> 
  pander()

```

**QUESTION:** Is it reasonable to use the next non-missing ApoE result to impute the ApoE results for the earlier visit? Note that in some cases, the ApoE value changes between visits:

If they are missing, it is reasonable to use the next available result. The issue with differences between visits will need to be addressed with Flora; the samples may have been run differently between visit leading to different APoE values. 

```{r, "multiple ApoE values", results = "asis"}

gp34 |> 
  semi_join(apoe.n |> filter(n_vals > 1), by = "FXS ID") |> 
  select(`FXS ID`, `Visit Date`, `Event Name` ,ApoE) |> 
  arrange(`FXS ID`, `Visit Date`) |> 
  split(~`FXS ID`) |> 
  pander()

```

## CGG

```{r}
cgg.n = gp34 |> missing_pattern_by_ID(variable = "CGG")
```

There's a lot of missing data in CGG as well:

```{r}

vars = grep("^CGG", names(gp34), value = TRUE)

table1(
  NA.label = NA.label1,
  formula(paste(
    "~", paste(formulaic::add.backtick(vars), collapse = " + "), 
    "|",
    column_var |> formulaic::add.backtick())),
  data = visit1)
```

`r cgg.n |> filter(first_missing) |> pull(any_nonmissing) |> sum()` of these participants have later records with non-missing CGG values:

```{r}

gp34 |> 
  semi_join(
    cgg.n |> 
      filter(
        first_missing,
        any_nonmissing), 
    by = "FXS ID") |> 
  select(`FXS ID`, `Visit Date`, `Event Name` , CGG) |> 
  arrange(`FXS ID`, `Visit Date`) |> 
  split(~`FXS ID`) |> 
  pander()
```

Some participants have multiple CGG values:

```{r, "multiple CGG values", include = TRUE, results = "asis"}

gp34 |> 
  semi_join(
    cgg.n |> 
      filter(
        n_vals > 1), 
    by = "FXS ID") |> 
  select(`FXS ID`, `Visit Date`, `Event Name` , CGG) |> 
  arrange(`FXS ID`, `Visit Date`) |> 
  split(~`FXS ID`) |> 
  pander()

```

We decided to use the most recent CGG value.

```{r, include = TRUE}
# check fxtas stage where CGG is missing
gp34 |> 
  filter(is.na(`FXTAS Stage (0-5)`)) |> 
  select(`FXS ID`, `Event Name`, CGG, `FXTAS Stage (0-5)`) |> 
  pander()

```



**Question:** can we fill in the earlier values using later values?

Yes this is reasonable. Shouldn’t change between visits.  
From Randi: use later versions if inconsistent, might change due to improvements in assays. 

## Lifestyle

**Question:** Alcohol is labeled "Alcohol Abuse" in GP3 (`mds_psy_alco`) vs. "Alcohol Use" in GP4 (`new_mds_psy_alco`); ok to combine?

Yes this is reasonable.  

**Question:** I didn't find any marijuana use data in GP3; is there anything we can do to fill it in?  

Unfortunately, the older Med data sheet in GP3 did not capture this value. However the new med data sheet was implemented in the later visits, thus some GP3 participants may have marijuana data. Maybe just use “drug use” and “alcohol use”. 

**Question:** What should we do with codes 888 and 999 for these variables? Should they be treated as "Never used" or as actual missing values? What about missing data (field empty in RedCap)? Can we fill in any data using the unstructured data in  "Drugs used" (`mds_psy_drug_notes`)?  

This is a difficult question to answer, as we don’t want to infer a response/answer. The missing data COULD be a result of poor record taking, as the med data sheet is treated much like a survey; (ie if “Yes”, it is marked). I feel that the 888, 999 can be combined to “none” and Missing data as “no data”. But I would double check with Kyoungmi on this. I think it is reasonable to fill in any drug use data using the unstructured data as you suggested. 


note: Discussed with Randi; Ala will look into it. We might be able to get some data from # drinks or from SCID 


```{r}
vars = c("Drug use",
         "Marijuana use",
         "Alcohol use/abuse",
         "# of drinks per day now",
         "# of drinks per day now: missingness")

table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)

```

## Cancer

**Question:** Can we fill in any data for Skin Cancer, Melanoma, or "Other Cancer"?  

Not sure I understand this question. 

**Question:** What should we do with codes 888 and 999 for these variables? Should they be treated as "Never used" or as actual missing values? What about blank entries (empty fields in RedCap)?  

Again I think 888 and 999 should be treated as “no” or “none” and missing values as “no data”. but will need to check with Kyoungmi. 

```{r}
vars = c(
  "Thyroid Cancer",
  "Skin Cancer",
  "Melanoma",
  "Prostate Cancer",
  "Other Cancer",
  "Any Cancer"
)

table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)
```


## Surgery

**Question:** Can we categorize the surgery data into a binary variable for GP4? (There are currently multiple surgery variables, `new_mds_med_sur1`, `new_mds_med_sur2`, etc., all with unstructured data.)  

Binary as in Surgery Yes or No? Yes I think that would be best. 

**Question:** Can we categorize surgery types into a small set of indicator variables?  

Yes, lets see what that will show.  

**Question:** Can we extract age at surgery and surgery dates from the unstructured text?  

We may, but this is really hit or miss and will take some time.  

**Question:** Do we have a source of anesthesia data for GP3?  

No.  

**Question:** Can we categorize anesthesia into a binary variable (yes/no), summarizing across all fields in GP4 (`new_mds_med_anes1`, `new_mds_med_anes2`, etc.)?  

Yes.  

**Question:** What should we do with missing codes and blanks?  

See my previous responses for 888, 999 and missing data.   

```{r}

vars = 
  c(
    "Surgery",
    "Anesthesia (medic_surg_anes)", 
    "Anesthesia (new_mds_med_anes1)"
    # "Other Cancer (detailed)", # don't include in table
    # "Surgery",
    # "Surgery type",
    # "Surgery: Type/Age",
    # "Surgery 2: Type/Age",
    # "Surgery 3: Type/Age",
    # "Surgery 4: Type/Age",
    # "Surgery 5: Type/Age",
  )
# grep(pattern = "surgery", ignore.case = TRUE, x = names(gp34), value = TRUE)

library(table1)
table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)
```

## Tremors

**Question:** What should we do with missing codes and blanks?  

See my previous responses on the matter.   

```{r}
vars = c(
  
  "Intention tremor",
  "Resting tremor",
  "Postural tremor",
  "Intermittent tremor",
  "Any tremor",
  "Tremor: Age of onset"
  # "Tremor: Age of onset: missingness"
)
table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)

```

Age of onset missingness reasons where any of the four above tremor types = "Yes":

```{r}

table1(
  NA.label = NA.label1,
  stratified_formula("Tremor: Age of onset: missingness", column_var),
  data = visit1 |> filter(`Any tremor` == "Some Tremors Recorded"))

```

## Head tremors

**Question:** Can we get any data on head tremor for GP3?  

Unfortunately head tremor was not collected in GP3   

```{r}
vars = c(
  "Head tremor",
  "Head Tremor: Age of onset"
  
)
table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)

```

Age of onset missingness reasons where "Head tremor" = "Yes":

```{r}

table1(
  NA.label = NA.label1,
  stratified_formula("Head Tremor: Age of onset: missingness", column_var),
  data = visit1 |> filter(`Head tremor` == "Yes"))

```



## Ataxia

**Question:** What should we do with missing codes and blanks?  

See my previous responses on the matter. 

```{r}

vars = c(
  "Ataxia",
  "Ataxia: severity",
  "Ataxia: severity*",
  "Ataxia: Age of onset",
  "Ataxia: Age of onset: missingness"
)

table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)

```

## Parkinsons

**Question:** Can we fill in Parkinsons (formal diagnosis) for GP3?  

No, because the question was not asked in GP3.    

**Question:** What should we do with missing codes and blanks?  

See my previous responses on the matter.  

```{r}

vars = grep("Parkinson", value = TRUE, names(gp34))

table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)

```

## FXTAS Stage


**Question:** What should we do with missing codes and blanks?  

For categorical analysis, we merged 2.5 into 2, 3.5 into 4, and 4.5 into 5.


```{r}

vars = c(
  "FXTAS Stage (0-5)",
  "FXTAS Stage (0-5)*")

table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)

# gp34 |> 
#   filter(`FXTAS Stage (0-5)` %in% c(NA, "No Response (999)", "Missing (empty in RedCap)")) |> 
#   select(`FXS ID`, `Event Name`, `Visit Date`) |> 
#   arrange() |> 
#   readr::write_csv("inst/extdata/missing_FXTAS_stage.csv")

```

## BDS2

**Question:** What should we do with missing codes and blanks?  

These should be treated as no data.  

```{r}

vars = grep("BDS-2 Total Score", value = TRUE, names(gp34), fixed = TRUE)

table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)

```

## MMSE

**Question:** What should we do with blanks?  

These should be treated as no data.  

```{r}

vars = grep(
  "MMSE Total Score", 
  value = TRUE, 
  names(gp34), 
  fixed = TRUE)

table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)

```

## SCID

**Question:** What should we do with missing codes and blanks?  

These should be treated as no Diagnosis.  

**Question:** Should we interpret "lifelong" age of onset (code 555) as since age 0?  

hmm, I am not sure about this one. Todo: ask Randi 

  -   decision: min(10, min(observed values)) 


```{r}

vars = c(
  "Was SCID completed?",
  "Bipolar I Disorder (MD01), Lifetime",
  "Bipolar I Disorder (MD01), Current",
  "Bipolar II Disorder (MD02), Lifetime",
  "Bipolar II Disorder (MD02), Current",
  "Other Bipolar Disorder (MD03), Lifetime",
  "Other Bipolar Disorder (MD03), Current",
  "Major Depressive Disorder (MD04), Lifetime",
  "Major Depressive Disorder (MD04), Current",
  "Mood Disorder Due to GMC (MD07), Lifetime",
  "Mood Disorder Due to a GMC (MD07), Current",
  "Substance-Induced Mood Dis. (MD08), Lifetime",
  "Substance-Induced Mood Dis. (MD08), Current",
  "Primary Psychotic Symptoms (PS01), Lifetime",
  "Primary Psychotic Symptoms (PS01), Current"
)

table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)

```

## SCL90

**Question:** What should we do with missing codes and blanks?  

No data.  

**Question:** Do we want to include "SCL90: Interpersonal Sensitivity" (was included in data extract, wasn't on Word doc list)?  

Yes.  

Ellery to look up scale cutoffs 

Followup: Randi said: 

  -   40-59 is average  
  -   60+ is clinically elevated 

```{r}

vars = grep(value = TRUE, fixed = TRUE, names(gp34), pattern = "SCL90") |> sort()

table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)

# visit1 |> ggplot(aes(x = `SCL90: Anxiety`, group = `FX*`)) + geom_histogram() + facet_wrap(~`FX*`, ncol = 1)
```

## MRI

**Question:** What should we do with missing codes and blanks? Can we use results from subsequent visits to fill in earlier visits?  

These should be treated as ‘no data’. We cannot use results from subsequent visits to fill earlier ones, as there may be significant MRI changes from visit to visit.  


```{r}

vars = c(
  "Cerebral Atrophy",
  "Cerebellar Atrophy",
  "Cerebral WM Hyperintensity",
  "Cerebellar WM Hyperintensity",
  "MCP-WM Hyperintensity",
  "Pons-WM Hyperintensity",
  "Sub-Insular WM Hyperintensity",
  "Periventricular WM Hyperintensity",
  "Splenium (CC)-WM Hyperintensity",
  "Genu (CC)-WM Hyperintensity",
  "Corpus Callosum-Thickness"
)

table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)

```

## WAIS 3/4

**Question:** Can we combine "Verbal: IQ Score" (`wais_verb_iq`) and "Verbal Comprehension: Composite Score (VCI)" (`wais4_verbcomp_cs`)?  

(wais_verb_iq) is from WAIS version 3 and (wais4_v, erbcomp_cs) is from WAIS version 4. so the answer is No, primarily because the norms used to set the scaled scores are different - so what it took to get a standard score of 7 may be different between the norms of WAIS III and IV, but also if the actual subtest has changed then it's certainly not a direct comparison as they are different tests.  

**Question:** Can we combine "Full Scale: IQ Score" (`wais_fullscale_iq`) and "Full Scale: Composite Score (FSIQ)" (`wais4_fullscale_cs`)?  

See previous answer on VERBAL IQ  

**Question:** Do we have any data for perceptual reasoning, working memory, or processing speed for GP3?  

No, b/c WAIS 3 does not have these scores but the subsequent WAIS 4 does.  

```{r}

vars = c(
  "Verbal: IQ Score",
  "Verbal Comprehension: Composite Score (VCI)",
  
  "Perceptual Reasoning: Composite Score (PRI)",
  "Working Memory: Composite Score (WMI)", 
  "Processing Speed: Composite Score (PSI)",
  
  "Full Scale: IQ Score",
  "Full Scale: Composite Score (FSIQ)"
) |> sapply(F = function(x) grep(value =  TRUE, fixed = TRUE, pattern = x, x = names(visit1))) |> as.vector()

table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)

```

## CANTAB

**Question:** All of these scores are completely missing in GP4 and almost entirely missing in GP3; do we have a way to fill in the missing data?  

Ahh yes, in GP4 the relevant instrument is “CANTAB CONN”. The variables should be found in that instrument if you query it.  

**Question:** The score "WMS Letter-Number Sequencing" is listed in the word document, but I didn't find it in the RedCap report. I saw a few seemingly-relevant variables in RedCap, but I wasn't sure which one to use?  

WMS III is another neurocognitive assessment that was used primarily in GP3 but dropped in GP4 because the WAIS 4 was implemented instead. We can leave this one out for now.   


To ask Randi: are these categorizable? Can we do anything for the GP3 records?


```{r}

# table1(
#   NA.label = NA.label1,
#   stratified_formula("Drugs used", column_var),
#   data = visit1)


cantab_vars = c(
  "SWM Between errors",
  "SST Median correct RT on GO trials",
  "RVP A signal detection",
  "OTS Problems solved on first choice",
  "PAL Total errors (adjusted)",
  "RTI Five-choice movement time") 
# |> 
#   sapply(F = function(x) grep(value =  TRUE, fixed = TRUE, pattern = x, x = names(visit1))) |> 
# as.vector()

table1(
  NA.label = "Missing (empty in RedCap)",
  stratified_formula(cantab_vars, column_var),
  data = visit1)
```

## Thyroid and other autoimmune diseases

**Question:** "Medical history of thyroid disease and age of onset" is listed in the word doc, but I wasn't sure which corresponding variables to analyze.  

Analyze “thyroid problems” mds_med_thy  and/or new_mds_med_thy  

**Question:** "ANA positive", "Raynauds Syndrome", and "Pulmonary Fibrosis" are completely missing in GP3; can we fill these in somehow?  

These values were not collected for GP3. 

**Question:** What should we do with the NA codes and blanks?  

These should be 888 and 999: “No”. Missing is “no data”  

```{r}

# table1(
#   NA.label = NA.label1,
#   stratified_formula("Drugs used", column_var),
#   data = visit1)


vars = c(
  "Hypothyroid",
  "Hyperthyroid",
  "Thyroid problems",
  "Lupus",
  "Rheumatoid arthritis",
  "Multiple Sclerosis: Workup",
  "ANA positive",
  "Sjogrens Syndrome",
  "Raynauds Syndrome",
  "Pulmonary Fibrosis"
  # "Immunological Notes"
  
  
)

table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)
```

## Other variables

**Question:** I didn't see any variables for:
* "Kinesia One score for Rt and Lt hands for all types of tremor." 
* "Purdue pegboard for reaction time"
* "MOCA"

Do we have variables for these scores?

-   Kinesia is an assessment that was done for GP4 only. The instrument can be queried in REDCAP 

-   MOCA also not in GP3 – drop 

-   Purdue – use pp_t1rlb_total; should be in both studies; not categorizable  

## Demographics

There is substantial missingness in both `Primary Ethnicity` and `Primary Race`; not sure if we will need these variables:  


Primary ethnicity we can drop. Primary race we may be able to look on Randi’s cards for that or ask her. There are only 44 to look up. 

```{r}

vars = c(
  "Age at first visit",
  "# visits",
  # column_var,
  "Gender",
  "Primary Ethnicity",
  "Primary Race"
  
)

table1(
  NA.label = NA.label1,
  stratified_formula(vars, column_var),
  data = visit1)
```

**Question:** For `age of onset` = "lifelong (555)", what numeric value should we use? Age 0?

# Visit dates

We also started looking at the longitudinal data, and had some questions about the visit dates:

## Missing visit dates

```{r}

tab = gp34 |> filter(is.na(`Visit Date`)) |> 
  select(Study:`Visit Date`)

```

There are `r nrow(tab)` records with missing visit dates.

**Question:** Can these missing dates be filled in?  

Yes I can fill these in.

```{r}
pander(tab)
```



## Duplicate visit dates

```{r}

tab = gp34 |> 
  group_by(`FXS ID`, `Visit Date`) |> 
  filter(n() > 1, !is.na(`Visit Date`[1])) |> 
  select(Study:`Visit Date`) |> 
  split(~`FXS ID`)

```

There are `r length(tab)` duplicate visit dates.

**Question:** Are these duplicate values correct?  

I will need to check these.  

```{r, results = "asis"}
pander(tab)
```



## Visits out of event sequence

```{r}
ooo = gp34 |>
  select(`FXS ID`, `Visit Date`, `Event Name`) |>
  group_by(`FXS ID`) |>
  filter(is.unsorted(`Event Name`[`Event Name` != "GP4 - Single Visit"])) |>
  # filter(any(`decreased age`, na.rm = TRUE)) |>
  # ungroup() |>
  split(~`FXS ID`)
```

`r length(ooo)` participants have visits occurring out of chronological order (e.g., GP4 Visit1 before GP3 Visit 1).

**Question:** Are these records correct?  

I will need to check these.  

```{r, results = "asis"}

pander(ooo)
```

