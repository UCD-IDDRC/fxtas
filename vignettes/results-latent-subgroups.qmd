### Results for latent subgroups analysis {#sec-latent-subgroups .appendix}

```{r}
#| label: set-optimal-subgroups
n_s = n_s_optimal = 6

results_cv_max = extract_results_from_pickle(
  n_s = n_s,
  dataset_name = dataset_name,
  output_folder = output_folder)
```

Based on the CVIC criterion (@sec-cvic), it appears that `r n_s` subgroups is the optimal number for the full, unstratified GP+GP4 dataset.
@fig-pvd_optimal shows positional variance diagrams (PVDs) for each of the subgroup clusters detected under this assumption, and @tbl-sg_demos shows the demographics of the patients clustered in each subgroup. Patients in the "Type 0" category were too early in the disease process to be classified into a subgroup.

```{r}
#| label: extract-PVD-optimal
figs = extract_figs_from_pickle(size.y = size.y,
  n_s = n_s,
  dataset_name = dataset_name,
  output_folder = output_folder)
```

::: landscape

```{r}
#| label: "fig-pvd_optimal"
#| layout-ncol: 2
#| fig-height: !expr pvd_height
#| fig-align: center
#| fig-cap: !expr glue::glue("positional variance diagrams for {n_s_optimal} subgroups")
#| fig-cap-location: top
#| column: page
#| fig-subcap:
#|   - "Subgroup 1"
#|   - "Subgroup 2"
#|   - "Subgroup 3"
#|   - "Subgroup 4"
#|   - "Subgroup 5"
#|   - "Subgroup 6"
library(ggplot2)

figs |> print_PVDs()

```

```{r}
#| tbl-cap: !expr glue::glue("Subgroup demographics ({n_s} subgroups)")
#| label: tbl-sg_demos
#| results: asis

table_subtype_by_demographics(
  patient_data,
  subtype_and_stage_table = 
    results_cv_max$subtype_and_stage_table
)

```

:::

```{r}
#| label: fig-stage-by-age
#| fig-cap: "ML stage by age and latent subtype"
#| include: true

stages = 
  results_cv_max$subtype_and_stage_table |> 
  mutate(
    age = patient_data$`Age at first visit`,
    id = patient_data$`FXS ID`
  )

library(ggplot2)
stages |>
  graph_stage_by_age()
  


```


