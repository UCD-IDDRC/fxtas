---
title: "SuStaIn-ModelFitting"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SuStaIn-ModelFitting}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(fxtas)
library(tidyverse)
```


# Import data

```{r}

df = system.file("extdata", "synthetic_data.xlsx", package = "fxtas") |> readxl::read_excel()

biomarkers = c('Biomarker 1', 'Biomarker 2', 'Biomarker 3',
               'Biomarker 4', 'Biomarker 5')


```

# Set up data for new version of SuStaIn
The objective here is two create to variables:

* `p_NL` -- a subject x region matrix indicating the p that a region is normal for a subject.
* `p_score` -- a subject x (region * score) matrix indicating p that a region is a given score.

Ps should be non-zero. 

```{r}

ModelScores = DataScores = as.character(0:3)

control_data = df |> filter(Category == "Control") |> select(all_of(biomarkers))
patient_data = df |> filter(Category == "Patient") |> select(all_of(biomarkers))

# prob_correct = (control_data == 0) |> colMeans()
prob_correct = 
  df |> 
  filter(Category == "Control") |> 
  summarize(
    across(
      .cols = biomarkers, 
      .fn = ~ mean(.x == 0))
  ) |> 
  unlist()

prob_dist = 
  biomarkers |> 
  lapply(
    F = function(x) 
    {
      array()
    }
  )

prob_dist_dims = 
  list(
    modelscore = ModelScores,
    datascore = DataScores,
    biomarker = biomarkers)

prob_dist = array(
  NA,
  dim = sapply(length, X = prob_dist_dims),
  dimnames = prob_dist_dims)

for (biomarker in biomarkers)
{
  for (datascore in DataScores)
  {
    for (modelscore in ModelScores)
    {
      if(datascore == modelscore)
      {
        prob_dist[modelscore, datascore, biomarker] = prob_correct[biomarker] 
      } else
      {
        prob_dist[modelscore, datascore, biomarker] = 
          (1 - prob_correct[biomarker] ) / (length(DataScores) - 1)
      }
    }
  }
}

prob_nl_dist = prob_dist[1, , ]
prob_score_dist = prob_dist[-1, , ]

```

```{r}

prob_score_dims = 
  list(
  ID = df |> filter(Category == "Patient") |> pull(Index),
  Biomarker = biomarkers,
  model = ModelScores
)
  
prob_score0 = array(
  NA,
  dim = prob_score_dims |> sapply(length),
  dimnames = prob_score_dims
)

for (biomarker in biomarkers)
{
  for (datascore in DataScores)
  {
    for (modelscore in ModelScores)
    {
      prob_score0[patient_data[[biomarker]] == datascore, biomarker, modelscore] = 
        prob_dist[modelscore, datascore, biomarker]
    }
    
  }
}

prob_nl = prob_score0[,,"0"]
prob_score = prob_score0[,,-1]

```

```{r}

prob_nl = 
  patient_data |> 
  mutate(
    `P(X|C=0)` = 
  )
left_join(
  prob_dist |> filter(modelscore == 0) |> select()
)

```

