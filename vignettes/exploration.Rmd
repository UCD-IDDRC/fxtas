---
title: "exploration"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{exploration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  comment = "#>",
  fig.width = 7.5,
  fig.height = 4
)
```

```{r setup}
library(fxtas)
library(pander)
library(table1)
NA.label = "Missing (empty in RedCap)"

# load_all()
```

## plotly

```{r}

library(plotly)
library(dplyr)
gp34 |> 
  nest_by(Study) |> 
  mutate(
    p = 
      plot_ly(data,
              type = "scatter",
              mode = "lines+markers",
              color = ~`FXS ID`,
              x = ~`Event Name`,
              y = ~`Age at visit`,
              showlegend = FALSE
      ) |> 
      plotly::layout(
        xaxis = list(title = "")
        # title = "banana"
      ) |> 
      list()
  ) |> 
  pull(p) |> 
  plotly::subplot(
    nrows = 1, shareX = TRUE, shareY = TRUE)

```

## ggplot

```{r}

library(ggplot2)

plot1 = gp34 |> 
  ggplot(
    data = _,
    mapping = aes(
      color = `FXS ID`,
      group = `FXS ID`,
      y = `Event Name`,
      x = `Age at visit`
    )) +
  geom_point() + 
  geom_line() +
  theme_bw() +
  facet_grid(rows = vars(Gender)) +
  theme(legend.position="none")

print(plot1)

plot1 |> plotly::ggplotly()


```

## demographics

```{r}

visit1 = 
  gp34 |> 
  arrange(`FXS ID`, `Visit Date`, `Event Name`) |> 
  group_by(`FXS ID`) |> 
  slice_head(n = 1) |>
  ungroup() |> 
  rename(
    `Age at first visit` = `Age at visit`,
    `Recruited in study phase` = Study
  ) |> 
  left_join(
    gp34 |> count(`FXS ID`, name = "# visits"),
    by = "FXS ID"
  ) |> 
  mutate(`# visits` = factor(`# visits`, levels = 1:6))


```

## Missing visit date

```{r}

tab = gp34 |> filter(is.na(`Visit Date`)) |> 
  select(Study:`Visit Date`)

```

There are `r nrow(tab)` records with missing visit dates:

```{r}
pander(tab)
```

## Duplicate visit date

```{r}

tab = gp34 |> 
  group_by(`FXS ID`, `Visit Date`) |> 
  filter(n() > 1) |> 
  select(Study:`Visit Date`) |> print(n = Inf)

```

There are `r nrow(tab)` duplicate visit dates:

```{r}
pander(tab)
```

## Data from first visits

Here, we review the data from the first visits by each participant, stratified by 
the study phase in which they first enrolled (GP3 vs GP4).

### APOE

```{r}
apoe.n = gp34 |> missing_pattern_by_ID(variable = "ApoE")

```

Many participants (`r sum(apoe.n$first_missing)` of `r nrow(apoe.n)`) have ApoE missing in their first visit records:

```{r}

table1(
  NA.label = NA.label,
  formula(paste("~", paste(formulaic::add.backtick("ApoE"), collapse = " + "), "| `Recruited in study phase`")),
  # render.missing=c("Empty in RedCap"="FREQ (PCT%)"),
  data = visit1)
```


`r apoe.n |> filter(first_missing) |> pull(any_nonmissing) |> sum()` of these individuals have later visits with ApoE results; for example:

```{r}

gp34 |> filter(
  # `FXS ID` == "500011-122"
  `FXS ID` == apoe.n |> filter(first_missing, any_nonmissing) |> head(1) |> pull(`FXS ID`)
) |> 
  select(`FXS ID`, `Event Name`, `Visit Date`, ApoE) |> 
  pander()

```

**QUESTION:** Is it reasonable to use the next non-missing ApoE result to impute the ApoE results for the earlier visit? Note that in some cases, the ApoE value changes between visits:

```{r, "multiple ApoE values"}

gp34 |> 
  semi_join(apoe.n |> filter(n_vals > 1, first_missing)) |> 
  select(`FXS ID`, `Visit Date`, `Event Name` ,ApoE) |> 
  arrange(`FXS ID`) |> 
  pander()

```

### CGG

```{r}
cgg.n = gp34 |> missing_pattern_by_ID(variable = "CGG")
```

There's a lot of missing data in CGG as well:

```{r}

vars = grep("^CGG", names(gp34), value = TRUE)

table1(
  NA.label = NA.label,
  formula(paste(
    "~", paste(formulaic::add.backtick(vars), collapse = " + "), 
    "| `Recruited in study phase`")),
  data = visit1)
```

`r cgg.n |> filter(first_missing) |> pull(any_nonmissing) |> sum()` of these participants have later records with non-missing CGG values.

```{r, "multiple CGG values", include = FALSE}

gp34 |> 
  semi_join(cgg.n |> filter(n_vals > 1, first_missing)) |> 
  select(`FXS ID`, `Visit Date`, `Event Name` , CGG) |> 
  arrange(`FXS ID`) |> 
  pander()

```

**Question:** can we fill in the earlier values using later values?

### Lifestyle

**Question:** Alcohol is labeled "Alcohol Abuse" in GP3 vs. "Alcohol Use" in GP4; ok to combine?

**Question:** I didn't find any marijuana use data in GP3; is there anything we can do to fill it in?

**Question:** What should we do with codes 888 and 999 for these variables? Should they be treated as "Never used" or as actual missing values? What about missing data (field empty in RedCap)?


```{r}
vars = c("Drug use",
         "Marijuana use",
         "Alcohol use/abuse")

table1(
  NA.label = NA.label,
  stratified_formula(vars, "Recruited in study phase"),
  data = visit1)

```

```{r}

vars = c(
  "# of drinks per day now",
  "# of drinks per day now: missingness")

table1(
  NA.label = "Missing (see breakdown below)",
  stratified_formula(vars, "Recruited in study phase"),
  data = visit1)

```

### Cancer

**Question:** Can we fill in any data for Skin Cancer, Melanoma, or "Other Cancer"?

**Question:** What should we do with codes 888 and 999 for these variables? Should they be treated as "Never used" or as actual missing values? What about missing data (field empty in RedCap)?

```{r}
vars = c(
  "Thyroid Cancer",
  "Skin Cancer",
  "Melanoma",
  "Prostate Cancer",
  "Other Cancer"
  
)

table1(
  NA.label = NA.label,
  stratified_formula(vars, "Recruited in study phase"),
  data = visit1)
```


### Surgery

**Question:** Can we categorize the surgery data into a binary variable for GP4? (There are currently multiple surgery variables, `new_mds_med_sur1`, `new_mds_med_sur2`, etc., all with unstructured data.)

**Question:** Can we categorize surgery types into a small set of indicator variables?

**Question:** Can we extract age at surgery and/or surgery date from the unstructured text?

**Question:** Do we have a source of anesthesia data for GP3?

**Question:** Can we categorize anesthesia into a binary variable (yes/no), summarizing across all fields in GP4 (`new_mds_med_anes1`, `new_mds_med_anes2`, etc.)?

**Question:** What should we do with codes 777, 888, 999? Can we fill in any of the missing (empty in RedCap) values?

```{r}

vars = 
  c(
    "Surgery",
    "Anesthesia (medic_surg_anes)", 
    "Anesthesia (new_mds_med_anes1)"
    # "Other Cancer (detailed)", # don't include in table
    # "Surgery",
    # "Surgery type",
    # "Surgery: Type/Age",
    # "Surgery 2: Type/Age",
    # "Surgery 3: Type/Age",
    # "Surgery 4: Type/Age",
    # "Surgery 5: Type/Age",
  )
# grep(pattern = "surgery", ignore.case = TRUE, x = names(gp34), value = TRUE)

library(table1)
table1(
  NA.label = NA.label,
  stratified_formula(vars, "Recruited in study phase"),
  data = visit1)
```

### Tremors

```{r}
vars = c(
  
  "Intention tremor",
  "Resting tremor",
  "Postural tremor",
  "Intermittent Tremor",
  "Tremor: Age of onset",
  "Tremor: Age of onset: missingness",
  
  "Head tremor",
  "Head Tremor: Age of onset",
  "Head Tremor: Age of onset: missingness"
  
)
table1(
  NA.label = NA.label,
  stratified_formula(vars, "Recruited in study phase"),
  data = visit1)
```


```{r}

vars = c(
  
  
  "Ataxia",
  "Ataxia: severity",
  "Ataxia: Age of onset",
  "Ataxia: Age of onset: missingness",
  
  grep("Parkinson", value = TRUE, names(gp34)),
  
  "FXTAS Stage (0-5)",
  
  grep("BDS-2 Total Score", value = TRUE, names(gp34), fixed = TRUE),
  grep("MMSE Total Score", value = TRUE, names(gp34), fixed = TRUE),
  
  grep("Interviewers Diagnosis", value = TRUE, names(gp34), fixed = TRUE) |> sort(),
  # grep("score", value = TRUE, names(gp34), ignore.case = TRUE) |> sort(),
  
  grep(value = TRUE, fixed = TRUE, names(gp34), pattern = "Somatization (T-score: Nonpatient)"),
  grep(value = TRUE, fixed = TRUE, names(gp34), pattern = "Obsessive-Compulsive (T-score: Nonpatient)"),
  grep(value = TRUE, fixed = TRUE, names(gp34), pattern = "Interpersonal Sensitivity T-score: Nonpatient"),
  grep(value = TRUE, fixed = TRUE, names(gp34), pattern = "Depression (T-score: Nonpatient)"), 
  grep(value = TRUE, fixed = TRUE, names(gp34), pattern = "Anxiety (T-score: Nonpatient)"),
  grep(value = TRUE, fixed = TRUE, names(gp34), pattern = "Hostility (T-score: Nonpatient)"),
  grep(value = TRUE, fixed = TRUE, names(gp34), pattern = "Phobia (T-score: Nonpatient)"),
  grep(value = TRUE, fixed = TRUE, names(gp34), pattern = "Paranoid Ideation (T-score: Nonpatient)",),
  grep(value = TRUE, fixed = TRUE, names(gp34), pattern = "Psychoticism (T-score: Nonpatient)"),
  grep(value = TRUE, fixed = TRUE, names(gp34), pattern = "Global Severity Index (T-score: Nonpatient)"),
  grep(value = TRUE, fixed = TRUE, names(gp34), pattern = "Positive Symptom Distress Index (T-score: Nonpatient)"),
  grep(value = TRUE, fixed = TRUE, names(gp34), pattern = "Positive Symptom Total (T-score: Nonpatient)"),
  
  "Cerebral Atrophy",
  "Cerebellar Atrophy",
  "Cerebral WM Hyperintensity",
  "Cerebellar WM Hyperintensity",
  "MCP-WM Hyperintensity",
  "Pons-WM Hyperintensity",
  "Sub-Insular WM Hyperintensity",
  "Periventricular WM Hyperintensity",
  "Splenium (CC)-WM Hyperintensity",
  "Genu (CC)-WM Hyperintensity",
  "Corpus Callosum-Thickness",
  
  "Verbal: IQ Score",
  "Verbal Comprehension: Composite Score (VCI)",
  
  "Perceptual Reasoning: Composite Score (PRI)",
  "Working Memory: Composite Score (WMI)", 
  "Processing Speed: Composite Score (PSI)",
  
  "Full Scale: Composite Score FSIQ)", 
  "Full Scale: IQ Score",
  
  "Drugs used",
  
  "SWM Between errors",
  "SST Median correct RT on GO trials",
  "RVP A",
  "OTS Problems solved on first choice",
  "PAL Total errors (adjusted)",
  "RTI Five-choice movement time",
  
  "Lupus",
  "Rheumatoid arthritis",
  "Multiple Sclerosis: Workup",
  "ANA positive",
  "Sjogrens Syndrome",
  "Raynauds Syndrome",
  "Pulmonary Fibrosis"
  # "Immunological Notes"
  
  
  
  
)

table1(
  NA.label = NA.label,
  stratified_formula(vars, "Recruited in study phase"),
  data = visit1)
```



### Demographics

There is substantial missingness in both `Primary Ethnicity` and `Primary Race`. 
Not sure if we will need these variables.
```{r}

vars = c(
  "Age at first visit",
  "# visits",
  # "Recruited in study phase",
  "Gender",
  "Primary Ethnicity",
  "Primary Race"
  
)

table1(
  NA.label = NA.label,
  stratified_formula(vars, "Recruited in study phase"),
  data = visit1)
```
