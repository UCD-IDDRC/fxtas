#' Plot positional variance diagram
#' @inheritParams format_results_list
#' @param samples_sequence todo
#' @param samples_f todo
#' @param n_samples todo
#' @param score_vals todo
#' @param biomarker_labels todo
#' @param ml_f_EM todo
#' @param cval todo
#' @param subtype_order todo
#' @param biomarker_order todo
#' @param title_font_size todo
#' @param stage_font_size todo
#' @param stage_label todo
#' @param stage_rot todo
#' @param stage_interval todo
#' @param label_font_size todo
#' @param label_rot todo
#' @param cmap a [character]
#' @param biomarker_colours a [character] vector of colors
#' @param subtype_titles todo
#' @param separate_subtypes todo
#' @param save_path todo
#' @param save_kwargs todo
#' @param results todo
#' @param biomarker_levels doesn't do much right now
#' @param biomarker_groups biomarker groupings
#' @param biomarker_events_table todo
#' @param biomarker_event_names todo
#' @param biomarker_plot_order todo
#' @param synchronize_y_axes todo
#' @inheritDotParams autoplot.PF
#' @returns a `"PVD.list` (a [list] of `PVD` objects from [autoplot.PF()])
#' @export
#' @example inst/examples/exm-plot_positional_var.R
plot_positional_var <- function(
    results,
    samples_sequence = results$samples_sequence,
    samples_f = results$samples_f,
    n_samples = results$ml_subtype |> nrow(),
    score_vals = build_score_vals(biomarker_levels),
    biomarker_labels = names(biomarker_levels),
    biomarker_groups = results |> attr("biomarker_groups"),
    biomarker_levels = results |> attr("biomarker_levels"),
    biomarker_events_table = biomarker_levels |>
      get_biomarker_events_table(),
    biomarker_event_names = biomarker_events_table |>
      dplyr::pull("biomarker_level"),
    biomarker_plot_order = NULL,
    # ml_f_EM = results$ml_f_EM,
    ml_f_EM = NULL,
    cval = FALSE,
    subtype_order = seq_len(dim(samples_sequence)[1]),
    # subtype_order = NULL,
    biomarker_order = NULL,
    title_font_size = 12,
    stage_font_size = 10,
    stage_label = "Sequential order",
    stage_rot = 0,
    stage_interval = 1,
    label_font_size = 10,
    label_rot = 0,
    cmap = "original",
    biomarker_colours = NULL,
    subtype_titles = NULL,
    separate_subtypes = FALSE,
    save_path = NULL,
    save_kwargs = NULL,
    synchronize_y_axes = FALSE,
    ...) {
  # Get the number of subtypes
  N_S <- dim(samples_sequence)[1]
  # Get the number of features/biomarkers
  N_bio <- score_vals |> nrow()
  # Check that the number of labels given match
  if (!is.null(biomarker_labels)) {
    stopifnot(length(biomarker_labels) == N_bio)
  }

  # Set subtype order if not given
  if (is.null(subtype_order)) {
    # Determine order if info given
    if (!is.null(ml_f_EM)) {
      subtype_order <- ml_f_EM |> base::order(decreasing = TRUE)

      # Otherwise determine order from samples_f
    } else {
      subtype_order <- samples_f |>
        rowMeans() |>
        base::order(decreasing = TRUE)
      # np.argsort(np.mean(samples_f, 1))[::-1]
    }
  }

  # Unravel the stage scores from score_vals
  stage_score <- score_vals |> as.vector()
  IX_select <- which(stage_score != 0)
  stage_score <- stage_score[IX_select]

  # Get the scores and their number
  num_scores <- unique(stage_score)
  N_z <- length(num_scores)
  # Extract which biomarkers have which zscores/stages
  stage_biomarker_index <- rep(1:N_bio, times = N_z)
  stage_biomarker_index <- stage_biomarker_index[IX_select]
  # Warn user of reordering if labels and order given
  if (!is.null(biomarker_labels) && !is.null(biomarker_order)) {
    cli::cli_warn(
      c(
        "Both labels and an order have been given.\n",
        "The labels will be reordered according to the given order!"
      )
    )
  }
  if (!is.null(biomarker_order)) {
    # self._plot_biomarker_order is not suited to this version
    # Ignore for compatability, for now
    # One option is to reshape, sum position, and lowest->highest determines order
    if (length(biomarker_order) > N_bio) {
      biomarker_order <- 1:N_bio
    }
    # Otherwise use default order
  } else {
    biomarker_order <- 1:N_bio
  }

  # If no labels given, set dummy defaults
  if (is.null(biomarker_labels)) {
    biomarker_labels <- paste("Biomarker", 1:N_bio)
    # Otherwise reorder according to given order (or not if not given)
  } else {
    biomarker_labels <- biomarker_labels[biomarker_order]
  }
  # Check number of subtype titles is correct if given
  if (!is.null(subtype_titles)) {
    stopifnot(length(subtype_titles) == N_S)
  }
  # Z-score colour definition
  colour_mat <- get_colour_mat(cmap, N_z) # nolint: object_usage_linter

  # Check biomarker label colours
  # If custom biomarker text colours are given
  if (!is.null(biomarker_colours)) {
    biomarker_colours <- check_biomarker_colours(
      biomarker_colours,
      biomarker_labels
    )
    # Default case of all-black colours
    # Unnecessary, but skips a check later
  } else {
    biomarker_colours <- rep("black", length(biomarker_labels))
  }

  # Container for all figure objects
  figs <- list()
  # Loop over figures
  for (i in 1:N_S) {
    # Create the figure and axis for this subtype loop

    # confus_matrix_c =
    #   samples_sequence[subtype_order[i],,] |>
    #   t() |>
    #   compute_heatmap(
    #     biomarker_labels = biomarker_labels,
    #     colour_mat = colour_mat,
    #     stage_biomarker_index = stage_biomarker_index,
    #     stage_score = stage_score,
    #     biomarker_event_names =
    #       biomarker_event_names
    #   )

    if (!is.null(subtype_titles)) {
      title_i <- subtype_titles[subtype_order[i]]
    } else {
      title_i <- get_title_i_2(
        subtype_and_stage_table =
          results$subtype_and_stage_table,
        cval = cval,
        i = subtype_order[i]
        # i = i
      )
    }

    # heatmap_table =
    #   confus_matrix_c |>
    #   as.data.frame.table() |>
    #   as_tibble() |>
    #   pivot_wider(
    #     id_cols = c("biomarker","SuStaIn.Stage"),
    #     names_from = "color",
    #     values_from = "Freq") |>
    #   arrange(biomarker, SuStaIn.Stage)
    #
    # # Plot the colourized matrix
    #
    # plot1 =
    #   heatmap_table |>
    #   heatmap_table_to_plot() +
    #   ggtitle(title_i)

    PFs <-
      samples_sequence[subtype_order[i], , ] |>
      extract_PFs(
        biomarker_events_table = biomarker_events_table,
        biomarker_plot_order = biomarker_plot_order,
        biomarker_groups = biomarker_groups
      )


    if (synchronize_y_axes) {
      biomarker_plot_order <- PFs |> attr("biomarker_order")
    }

    PF.plot <-
      PFs |>
      autoplot.PF(...) +
      ggplot2::ggtitle(title_i)


    figs[[i]] <- structure(
      PF.plot,
      biomarker_order = PFs |> attr("biomarker_order"),
      # alt_plot = plot1,
      title = title_i
    )
    # https://medium.com/@tobias.stalder.geo/plot-rgb-satellite-imagery-in-true-color-with-ggplot2-in-r-10bdb0e4dd1f
  }

  if (length(figs) == 1) {
    figs <- figs[[1]]
  } else {
    subtype_names0 <- dimnames(samples_sequence)[[1]]
    if (!is.null(subtype_names0)) {
      names(figs) <- subtype_names0[subtype_order]
    } else {
      names(figs) <- paste("Subtype", seq_along(figs))
    }
    class(figs) <- c("PVD.list", class(figs))
  }

  figs <- figs |>
    structure(
      biomarker_event_names = biomarker_event_names
    )

  return(figs)
}
