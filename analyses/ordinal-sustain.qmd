---
title: |
  Progression of fragile X-associated tremor/ataxia syndrome 
  revealed by subtype and stage inference
format:
  html:
    echo: false
  docx: default
reference-doc: Brain_template_2022.docx
knitr:
  opts_chunk:
    fig.path: ordinal-sustain_files/figure-docx/
    # see https://github.com/quarto-dev/quarto-cli/discussions/4254
---

```{=html}
<style>
.quarto-figure-center > figure {
text-align: center;
}
</style>
```

```{r}
#| include: false
#| label: setup
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  include = TRUE
)
pander::panderOptions("table.split.table", Inf)
ggplot2::theme_set(
  ggplot2::theme_bw(base_family = "Arial")
)
```

```{r}
#| label: libraries
#| message: false

reticulate::use_condaenv("fxtas39", required = TRUE, conda = "auto")
library(fxtas)
library(tidyverse)
library(reticulate)
library(pander)
library(table1)
library(magrittr)
library(knitr)
```


```{r}
#| label: "set run parameters"

max_prob_correct <- .95

do_collapse_scid_levels <- TRUE
do_collapse_mri_levels <- TRUE

fit_models <- TRUE
run_cv <- TRUE

verbose <- TRUE
rerun <- FALSE
# rerun <- FALSE
use_rds <- !rerun

plot_python <- TRUE
fig_size <- c(20, 10) # passed to pySuStaIn

# scale_colors1 = c("red", "blue", "magenta", "orange", "purple4")
scale_colors0 <- rcartocolor::carto_pal(name = "Safe")[c(9, 5, 7, 8, 4)]
scale_colors1 <- c("#882255", "#332288", "#44AA99", "#999933", "#117733") |> 
  setNames(
    c("violet red", "royal blue", "cadet blue", "khaki", "forest green"
    ) 
  )

color_list <- glue::glue(
  '[{{names(scale_colors1)}}]{color="{{scale_colors1}}"}', 
  .open = "{{", 
  .close = "}}"
)

library(rex)
color_names1 <- 
  loon::l_colorName(c("#882255", "#332288", "#44AA99", "#999933", "#117733")) |>  
  stringr::str_remove_all(pattern = rex::rex(digits))
pvd_height <- 5.5
pvd_width <- 6
pvd_subfig_width <- pvd_width - 1
pvd_line_height <- 6.69
pvd_line_width <- 8.1
pvd_line_subfig_width <- pvd_line_width
lineplot_text_size <- 3
size.y <- 8 # nolint: object_name_linter
y_text_size <- 10
N_startpoints <- 10L # nolint: object_name_linter
use_parallel_startpoints <- FALSE # couldn't get parallel to work, 2024/06/15
N_S_max <- 12L # nolint: object_name_linter
N_S_max_stratified <- 2L # nolint: object_name_linter
N_CV_folds <- 10L # nolint: object_name_linter

n_permutations <- 1000

outcomes_name <- "symptom"
events_name <- "symptomatic events"
outcomes_name_sentence_start <- stringr::str_to_sentence(outcomes_name)

compact_fig_caption <- paste(
  "The different colors (red, blue, magenta, orange, purple)",
  "indicate the ordinal levels of symptom progression.",
  "Color gradient intensity represents the Bayesian posterior probability", 
  "of the sequence position.",
  "The brighter the color, the more probable that the corresponding",
  outcomes_name,
  "event occurs in that position in the sequence."
)

compact_fig_cap2 <- glue::glue(
  "Red lines indicate {outcomes_name}s that moved to later positions ",
  "between the left-hand subgroup and the right-hand subgroup. ",
  "Blue lines indicate ",
  "{outcomes_name}s that moved to earlier positions. ",
  "Line opacity levels indicate the number of positions changed ",
  "(higher opacity represents more positions changed)."
)

column_var <- c("Gender", "FX3*")

N_iterations_MCMC <- 1e5L # nolint: object_name_linter
dataset_name <- "sample_data"
root_dir <- here::here()
setwd(root_dir)
output_folder <-
  "output/output.fixed_CV-scid-no-subthres/" |>
  fs::dir_create()
```

```{r}
#| label: subset-data
load("data/trax_gp34_v1.rda")

if (do_collapse_scid_levels) {
  scid_levels_to_collapse <- c("Absent", "Sub-Threshold")
  trax_gp34_v1 <- trax_gp34_v1 |> 
    collapse_scid_levels(
      scid_levels_to_collapse)
}

if (do_collapse_mri_levels) {
  trax_gp34_v1 <- trax_gp34_v1 |> collapse_mri_levels()
}

full_data <-
  trax_gp34_v1 |>
  add_labels()
```

```{r}
#| label: get-subsets
n_missing_CGG <- # nolint: object_name_linter
  full_data$CGG |>
  is.na() |>
  sum()
n_above_200 <- sum(full_data$CGG >= 200, na.rm = TRUE)
v1_usable <-
  full_data |>
  dplyr::filter(CGG < 200) |>
  dplyr::mutate(
    `FX3*` = .data$`FX3*` |>
      forcats::fct_drop()
  )

v1_usable_males <- v1_usable |> dplyr::filter(Gender == "Male")
v1_usable_females <- v1_usable |> dplyr::filter(Gender == "Female")
v1_usable_cases <- v1_usable |> dplyr::filter(CGG >= 55)
v1_usable_male_cases <-
  v1_usable |>
  dplyr::filter(
    Gender == "Male",
    CGG >= 55
  )

v1_usable_female_cases <-
  v1_usable |>
  dplyr::filter(
    Gender == "Female",
    CGG >= 55
  )

v1_usable_male_controls <-
  v1_usable |>
  dplyr::filter(
    Gender == "Male",
    CGG < 55
  )

v1_usable_female_controls <-
  v1_usable |>
  dplyr::filter(
    Gender == "Female",
    CGG < 55
  )
# note: there are 231 records in `visit1` with CGG >= 55, but 4 have CGG >= 200
# previously `nrow(v1_usable_cases)` was 221,
# which was based on incorrectly filtering on a version of CGG
# that hadn't been backfilled.

controls_v1 <- v1_usable |> dplyr::filter(CGG < 55)
year_range <- v1_usable$`Visit Date` |>
  year() |>
  range()
min_year <- min(year_range)
max_year <- max(year_range)

control_data <- controls_v1
patient_data <- v1_usable_cases
```

```{r}
#| label: "biomarker-events"
biomarker_groups <- compile_biomarker_groups_table(
  dataset = v1_usable
)
# biomarker_groups |> saveRDS(file = fs::path(output_folder, "biomarker_groups.rds"))

biomarker_varnames <-
  biomarker_groups |>
  dplyr::pull("biomarker")

biomarker_levels <-
  v1_usable |>
  get_levels(biomarker_varnames)

biomarker_events_table <-
  make_biomarker_events_table(
    biomarker_levels,
    biomarker_groups = biomarker_groups
  )

nlevs <-
  biomarker_levels |> sapply(length)
max_levels <- nlevs |> max()
```

# Abstract {.unnumbered}

{{< include _sec_abstract.qmd >}}

{{< pagebreak >}}

Correspondence to: Douglas Ezra Morrison  
Medical Sciences 1C #113  
One Shields Ave  
Davis, CA 95616  
<demorrison@ucdavis.edu>  

**Running title:** Progression of FXTAS symptoms

**Keywords:** 
fragile X-associated tremor/ataxia syndrome; 
subtype and stage inference; 
disease development and progression; 
sex differences; 
latent subgroups

{{< pagebreak >}}

# Introduction

{{< include _sec_intro.qmd >}}

# Materials and methods

## Data

### Study cohorts

{{< include _sec_study_cohorts.qmd >}}

### `r outcomes_name_sentence_start`s of neurodegenerative events

{{< include _sec_biomarkers.qmd >}}

## Statistical analysis {#sec-Statistical-analysis}

### Ordinal SuStaIn model {#sec-scored-events-model}

{{< include _sec_ordinal_sustain_model.qmd >}}

### Imputation of missing data {#sec-incomplete-data}

{{< include _sec_incomplete_data.qmd >}}

### Statistical hypothesis tests

{{< include _sec_hypothesis_tests.qmd >}}

### Latent subtype clustering {#sec-methods-latent-subtypes}

{{< include _sec_methods_clustering.qmd >}}

<!-- {{< include _methods_longitudinal.qmd >}} -->

### Visualizing modeling results

{{< include _sec_pvd_description.qmd >}}

## Software

{{< include _sec_software.qmd >}}

# Results

```{r}
#| label: get-control-dists

prob_correct <-
  control_data |>
  compute_prob_correct(
    max_prob = max_prob_correct,
    biomarker_levels = biomarker_levels
  )
```

```{r}
#| message: false
#| label: model-all-subgroups-first-visits
#| include: false

if (fit_models) {
  
  sustain_output <- run_and_save_OSA(
    verbose = verbose,
    biomarker_levels = biomarker_levels,
    prob_correct = prob_correct,
    SuStaInLabels = biomarker_varnames,
    N_startpoints = N_startpoints,
    N_S_max = N_S_max,
    N_iterations_MCMC = N_iterations_MCMC,
    output_folder = output_folder,
    dataset_name = dataset_name,
    use_parallel_startpoints = use_parallel_startpoints,
    seed = 1,
    plot = plot_python,
    rerun = rerun,
    patient_data = patient_data,
    N_CV_folds = N_CV_folds
  )
}
```

{{< include _sec_run_stratified_models.qmd >}}

```{r}
#| label: extract-figs

results_v1 <- extract_results_from_pickles(
  use_rds = use_rds,
  n_s = 1:N_S_max,
  rda_filename = "data.RData",
  dataset_name = "sample_data",
  output_folder = output_folder,
  verbose = verbose
)

results_females_first = extract_results_from_pickle(
  use_rds = use_rds,
  n_s = 1,
  rda_filename = "data.RData",
  dataset_name = "females",
  output_folder = output_folder
)

results_males_first = extract_results_from_pickle(
  use_rds = use_rds,
  n_s = 1,
  rda_filename = "data.RData",
  dataset_name = "males",
  output_folder = output_folder
)

fig_females_first <- extract_figs_from_pickle(
  biomarker_groups = biomarker_groups,
  use_rds = use_rds,
  size.y = size.y,
  n_s = 1,
  rda_filename = "data.RData",
  dataset_name = "females",
  output_folder = output_folder
)

fig_males_first <- extract_figs_from_pickle(
  biomarker_groups = biomarker_groups,
  use_rds = use_rds,
  size.y = size.y,
  n_s = 1,
  rda_filename = "data.RData",
  dataset_name = "males",
  output_folder = output_folder
)

fig_both_first <- extract_figs_from_pickle(
  biomarker_groups = biomarker_groups,
  use_rds = use_rds,
  size.y = size.y,
  n_s = 1,
  rda_filename = "data.RData",
  dataset_name = "sample_data",
  output_folder = output_folder
)

fig_both_first2 <-
  list(fig_both_first) |>
  plot_compact_pvd(
    scale_colors = scale_colors1
  )

fig_both_first2 |> 
  ggplot2::ggsave(
    height = 120, 
    width = 120,
    units = "mm", 
    dpi = 600,
    filename = "output/thumbnail.jpeg"
  )

fig_under100 <- extract_figs_from_pickle(
  biomarker_groups = biomarker_groups,
  use_rds = use_rds,
  size.y = size.y,
  n_s = 1,
  dataset_name = "under100",
  output_folder = output_folder
)

fig_over100 <- extract_figs_from_pickle(
  biomarker_groups = biomarker_groups,
  use_rds = use_rds,
  size.y = size.y,
  n_s = 1,
  dataset_name = "over100",
  output_folder = output_folder
)

fig_under100_males <- extract_figs_from_pickle(
  biomarker_groups = biomarker_groups,
  use_rds = use_rds,
  size.y = size.y,
  n_s = 1,
  dataset_name = "under100_Male",
  output_folder = output_folder
)

fig_over100_males <- extract_figs_from_pickle(
  biomarker_groups = biomarker_groups,
  use_rds = use_rds,
  size.y = size.y,
  n_s = 1,
  dataset_name = "over100_Male",
  output_folder = output_folder
)


fig_under100_females <- extract_figs_from_pickle(
  biomarker_groups = biomarker_groups,
  use_rds = use_rds,
  size.y = size.y,
  n_s = 1,
  dataset_name = "under100_Female",
  output_folder = output_folder
)

fig_over100_females <- extract_figs_from_pickle(
  biomarker_groups = biomarker_groups,
  use_rds = use_rds,
  size.y = size.y,
  n_s = 1,
  dataset_name = "over100_Female",
  output_folder = output_folder
)
```

```{r}
#| label: basic-summary-stats
biomarkers_table <-
  v1_usable |>
  make_biomarkers_table(
    biomarker_varnames = biomarker_varnames,
    biomarker_events_table = biomarker_events_table
  )
```

{{< include _sec-results-pk-missing-issues.qmd >}}

{{< include _sec-results-demographics.qmd >}}

## Sex differences in sequential orders {#sec-methods-strat-sex}

```{r}
#| label: p-val-test-sex

permuted_test_stats <- collect_permutation_test_stats(
  output_folder = output_folder,
  permuting_variables = "Gender"
)

observed_test_stat <- get_observed_permutation_test_stat(
  output_folder,
  dataset_names = c("females", "males")
)

pval_sex_gp34_v1 <- permutation_test(
  observed_test_stat = observed_test_stat,
  permuted_test_stats = permuted_test_stats,
  n_permutations = n_permutations
)

pval_sex_gp34_v1_formatted <- pval_sex_gp34_v1 |> scales::label_pvalue()()

```


```{r}
#| eval: false
#| label: plot-permutation-test-sex
plot_permutation_results(
  permuted_test_stats,
  observed_test_stat)
```

We first characterized 
sequential orders of FXTAS symptoms by sex 
and sex differences in the estimated sequential orders.
@fig-first-only-pvd shows 
the estimated sequential orders
of FXTAS `r outcomes_name`s 
in males and females, 
and @fig-first-only-diffs highlights sex differences in those orders.
We found statistically significant evidence of a 
difference in sequences of `r events_name`
between males and females (p `r pval_sex_gp34_v1_formatted`). 
It appears that 
female premutation carriers developed 
mood disorder symptoms prior to FXTAS Stage 1 diagnosis,
whereas male carriers experienced these symptoms much later 
(after FXTAS Stage 4) (@fig-first-only-diffs).
Postural tremors developed between Stage 2 and 3 for females,
and between Stages 3 and 4 for males.
Several MRI biomarkers of decline
also appear to begin at earlier FXTAS stages for males,
except for mild MRI cerebral biomarkers, which began earlier in females.


```{r}
#| label: p-val-test-sex-under100

permuted_test_stats <- collect_permutation_test_stats(
  output_folder = output_folder,
  stratifying_levels = "CGG 55-99",
  permuting_variables = "Gender"
)

observed_test_stat <- get_observed_permutation_test_stat(
  output_folder,
  dataset_names = c("under100_Female", "under100_Male")
)

pval_under100_sex_gp34_v1 <- permutation_test(
  observed_test_stat = observed_test_stat,
  permuted_test_stats = permuted_test_stats,
  n_permutations = n_permutations
)
```

```{r}
#| eval: false
#| label: plot-permutation-test-sex-under100
plot_permutation_results(
  permuted_test_stats,
  observed_test_stat)
```

```{r}
#| label: p-val-test-sex-over100

permuted_test_stats <- collect_permutation_test_stats(
  output_folder = output_folder,
  stratifying_levels = "CGG 100-199",
  permuting_variables = "Gender"
)

observed_test_stat <- get_observed_permutation_test_stat(
  output_folder,
  dataset_names = c("over100_Female", "over100_Male")
)

pval_over100_sex_gp34_v1 <- permutation_test(
  observed_test_stat = observed_test_stat,
  permuted_test_stats = permuted_test_stats,
  n_permutations = n_permutations
)
```

```{r}
#| eval: false
#| label: plot-permutation-test-sex-over-100
plot_permutation_results(
  permuted_test_stats,
  observed_test_stat)
```

To study whether observed sex differences were modulated by CGG repeats, 
we conducted subgroup analyses by CGG repeat size.
A statistically significant difference between males and females
was found among those with lower CGG repeats < 100
(CGG ; p = `r pval_under100_sex_gp34_v1`; 
@suppfig-pvd-by-gender-cgg_under100),
while a difference between males and females 
was not statistically significant 
among those with higher CGG repeats ≥ 100 
(p = `r pval_over100_sex_gp34_v1`;
@suppfig-pvd-by-gender-cgg_over100).
Several psychiatric disorders (as assessed by SCID) 
occurred prior to FXTAS Stage 1
among females with < 100 CGG repeats,
but at later FXTAS stages for males with < 100 CGG repeats.
MRI biomarkers appeared to occur at later stages in females compared to males.


```{r}
#| label: p-val-test-cgg-male

permuted_test_stats <- collect_permutation_test_stats(
  output_folder = output_folder,
  stratifying_levels = "Male",
  permuting_variables = "FX3"
)

observed_test_stat <- get_observed_permutation_test_stat(
  output_folder,
  dataset_names = c("under100_Male", "over100_Male")
)

pval_male_cgg_gp34_v1 <- permutation_test(
  observed_test_stat = observed_test_stat,
  permuted_test_stats = permuted_test_stats,
  n_permutations = n_permutations
)
```

```{r}
#| eval: false
#| label: plot-permutation-test-cgg-male
plot_permutation_results(
  permuted_test_stats,
  observed_test_stat)
```

```{r}
#| label: p-val-test-cgg-female

permuted_test_stats <- collect_permutation_test_stats(
  output_folder = output_folder,
  stratifying_levels = "Female",
  permuting_variables = "FX3"
)

observed_test_stat <- get_observed_permutation_test_stat(
  output_folder,
  dataset_names = c("under100_Female", "over100_Female")
)

pval_female_cgg_gp34_v1 <- permutation_test(
  observed_test_stat = observed_test_stat,
  permuted_test_stats = permuted_test_stats,
  n_permutations = n_permutations
)

n_over_100_female <-
  v1_usable |>
  dplyr::filter(
    Gender == "Female",
    CGG >= 100
  ) |>
  nrow()
```

```{r}
#| eval: false
#| label: plot-permutation-test-cgg-female
plot_permutation_results(
  permuted_test_stats,
  observed_test_stat)
```

We did not find significant evidence of an overall difference between CGG <100
and CGG ≥100 among males (p = `r pval_male_cgg_gp34_v1`) 
(@suppfig-pvd-by-cgg-male). 
SCID anxiety disorders and SWM between errors occurred 
prior to Stage 1 (1st and 2nd in sequence) in males with CGG repeats <100, 
whereas they occurred between stage 4 and 5 (32nd and 27th in sequence) 
in males with CGG repeats ≥ 100 
([Supplementary Fig. @fig-pvd-by-cgg-male-2]). 
Postural, 
resting, 
and 
intermittent tremor 
occurred in earlier FXTAS stages in those with CGG repeats <100 
compared to those with CGG repeats ≥100.
SCID substance use disorders and somatoform disorders
and MRI biomarkers 
occurred later in the event sequence in participants with CGG repeats <100 
compared to those with CGG repeats ≥100.  
We also did not find a significant difference between CGG <100 and CGG ≥100 
among females (p = `r pval_female_cgg_gp34_v1`) 
(@suppfig-pvd-by-cgg-female). 
It should be noted that this comparison lacked statistical power 
given the limited sample size of only 
`r n_over_100_female` females with CGG ≥100.

## Subtype clustering

```{r}
#| label: set-optimal-subtypes
sustain_output_CV <- sustain_output |> attr("CV")
n_s_min_CVIC <- which.min(sustain_output_CV$CVIC) # nolint: object_name_linter
n_s_selected <- 4
subtype_order <- c(3,1,4,2)
results_cv_max <- extract_results_from_pickle(
  n_s = n_s_selected,
  use_rds = FALSE,
  dataset_name = dataset_name,
  output_folder = output_folder,
  subtype_order = subtype_order
)
figs <- results_cv_max |> plot_positional_var(
  biomarker_groups = biomarker_groups
)
```

We conducted latent subtype classification analysis to cluster participants 
that are relatively homogeneous within the same cluster 
and heterogeneous from other clusters 
based on similarities and differences in sequential patterns. 
The cross-validation procedure
(Supplementary material, [Detecting latent subtypes](#sec-subtypes))
suggested `r n_s_min_CVIC` subtypes to be the optimal number for the full, 
unstratified dataset ([Supplementary Fig. @suppfig-cvic-1]).
The out-of-fold log-likelihood ("OOFLL") (Supplementary material, [Detecting latent subtypes](#sec-subtypes)) 
showed substantial fold-to-fold variation 
([Supplementary Fig. @suppfig-cvic-2]).
Between `r broman::spell_out(n_s_selected)` and `r broman::spell_out(N_S_max)` 
latent subtypes, 
the distribution of OOFLL appeared to be
approximately unchanging and the cross-validation information criterion (CVIC)
appeared approximately flat, 
and thus for clinical interpretation
and in consideration of the principle of parsimony, 
we chose to classify participants into `r n_s_selected` subtypes.

```{r}
#| label: compute-n-in-subtype-0

sust_data <- results_cv_max$subtype_and_stage_table |> 
  bind_cols(patient_data)

n_type_0 <- sust_data |>
  dplyr::filter(ml_subtype == "Type 0") |>
  nrow()

cgg_by_subtype <- sust_data |> 
  dplyr::summarize(
    .by = ml_subtype, 
    mean = mean(.data$CGG, na.rm = TRUE) |> round(1),
    sd = sd(.data$CGG, na.rm = TRUE) |> round(1)
  ) |> 
  as.data.frame()
rownames(cgg_by_subtype) = cgg_by_subtype$ml_subtype

cgg_overall <- sust_data |> 
  dplyr::summarize(
    mean = mean(.data$CGG, na.rm = TRUE) |> round(1),
    sd = sd(.data$CGG, na.rm = TRUE) |> round(1)
  )

test_sex <- 
  sust_data |> 
  filter(.data$ml_subtype != "Type 0") |> 
  droplevels() |> 
  select("ml_subtype", "Gender") |> 
  table() |> 
  prop.test()

test_cgg <- 
  sust_data |> 
  dplyr::filter(.data$ml_subtype != "Type 0") |> 
  stats::oneway.test(CGG ~ ml_subtype, data = _)


```

@suppfig-pvd_chosen_subtypes shows the estimated sequential event orders
for each of the subtype clusters.
<!-- @suppfig-pvd_chosen_subtypes_linegraphs  -->
@fig-pvd_chosen_subtypes_bumpplot
shows 
differences in event sequences between subtypes. 
@tbl-sg_demos shows 
the demographics of the patients clustered in each subtype. 
`r n_type_0 |> xfun::numbers_to_words() |> Hmisc::capitalize()` 
patients had experienced too few events 
to be accurately classified into a subtype 
and were excluded from @tbl-sg_demos.
Subtype clustering analysis showed that 
CGG repeat size,
a known risk factor of FXTAS,
contributed to the segregation of subtypes 
and variations between subtypes 
(p-value = `r test_cgg$p.value |> scales::pvalue()`).
We labeled the subtypes in descending order of mean CGG repeats. 
Individuals with higher CGG repeats
were over-represented in Subtype 1
(CGG repeats mean = 
`r cgg_by_subtype["Type 1", "mean"]` ± `r cgg_by_subtype["Type 1", "sd"]`)
compared to the overall study population 
(CGG repeats mean = `r cgg_overall$mean`  ± `r cgg_overall$sd`) 
and other subtypes.
Subtype 2 had CGG repeats close to the overall study population 
(`r cgg_by_subtype["Type 2", "mean"]` ± `r cgg_by_subtype["Type 2", "sd"]`).
Subtype 3 had fewer CGG repeats than the overall study population
(`r cgg_by_subtype["Type 3", "mean"]` ± `r cgg_by_subtype["Type 3", "sd"]`),
and 
Subtype 4 had the fewest CGG repeats
(`r cgg_by_subtype["Type 4", "mean"]` ± `r cgg_by_subtype["Type 4", "sd"]`).

{{< include _sec-subtype-diff-summary.qmd >}}

# Discussion

{{< include _sec_discussion.qmd >}}

# Data availability {.unnumbered}

The de-identified data used in this analysis may be provided 
upon request 
from the principal investigators of the two cohorts.

# Funding {.unnumbered}

This study was supported by the 
National Institute of Child Health and Human Development 
(NICHD, HD036071) 
and
UC Davis MIND Institute's 
Intellectual and Developmental Disabilities Research Center (IDDRC) 
(P50HD103256)
and the National Institute of Neurological Disorders and Stroke 
(NINDS, NS110100).

# Competing interests {.unnumbered}

The authors report no competing interests.

# Supplementary material {.unnumbered}

Supplementary material is available at Brain online.

# References {.unnumbered}

::: {#refs}
:::

{{< pagebreak >}}

:::{#tbl-demographics}

```{r}

v1_usable |> make_demographics_table(
  vars = c(
    "Age at visit",
    "Primary Race/Ethnicity",
    "FXTAS Stage",
    # "fxtas_dx",
    "CGG"
    # "Activation Ratio (0.0-1.0)"
  )
)
```

**Descriptive statistics of patient characteristics by Sex and CGG repeat level.**

:::

{{< pagebreak >}}

:::{#tbl-biomarker-list}

```{r}
flex_biomarkers_table(biomarkers_table)
```

**Symptoms included in analysis.**
The first level listed 
in each row of the
"Defined Ordered Levels" column
is the "reference level" for the corresponding symptom,
and subsequent levels are considered
"clinically elevated levels".
Columns "Female" and "Male" list percentages of
clinically elevated levels
at baseline visit, stratified by sex.

:::

{{< pagebreak >}}

::: {#tbl-sg_demos}


```{r}
set.seed(2)
tbl_sg_demos <- table_subtype_by_demographics(
  demographic_vars = c(
    "CGG",
    "Age at visit" , 
    "Male",
    "Primary Race/Ethnicity"
  ),
  patient_data = patient_data,
  subtype_and_stage_table = results_cv_max$subtype_and_stage_table,
  digits = list(
    CGG = 1,
    `FX3*` = c(0, 1),
    Gender = c(0, 1),
    `Primary Race/Ethnicity` = c(0, 1)
  )
)
```


```{r}
#| results: asis

tbl_sg_demos |>
  gtsummary::as_flex_table() |>
  shared_flextable_settings() |>
  flextable::width(width = 1.7) |>
  flextable::width(j = 2:6, width = 0.75) |>
  flextable::width(j = 7, width = 0.7)
```

**Demographics of `r n_s_selected` latent subtype clusters**
**identified by Ordinal SuStaIn.**
`r n_type_0` patients had experienced too few events
to be accurately classified into a subtype
and were excluded from this table.

:::

{{< include _sec_abbrev_table.qmd >}}

{{< pagebreak >}}

{{< include _tbl-critical-findings.qmd >}}

{{< pagebreak >}}

```{r}
#| label: fig-first-only-pvd
#| fig-height: !expr pvd_height
#| fig-width: !expr pvd_width
#| fig-cap: !expr
#|    glue::glue(
#|    "**Event sequences of FXTAS symptoms stratified by sex.**
#|    {compact_fig_caption}")
#| fig-cap-location: top

pvdc_sex <- list(
  "Males:" = fig_males_first,
  "Females:" = fig_females_first
) |>
  # plot_compact_pvd_est2()
  plot_compact_pvd(scale_colors = scale_colors1, y_text_size = y_text_size)

print(pvdc_sex)

list(
  "Males:" = fig_males_first,
  "Females:" = fig_females_first
) |>
  # plot_compact_pvd_est2()
  plot_compact_pvd(
    scale_colors = scale_colors1, 
    y_text_size = 10) |> 
  ggplot2::ggsave(
    height = 120, 
    width = 120,
    units = "mm", 
    dpi = 600,
    filename = "analyses/pvd_sex.pdf"
  )

```

{{< pagebreak >}}

```{r}
#| label: fig-first-only-diffs
#| fig-height: !expr pvd_line_height
#| fig-width: !expr pvd_line_width
#| fig-cap: !expr
#|    glue::glue(
#|    "**Positional differences in estimated event sequence between
#|    males and females.**
#|    {compact_fig_cap2}")
#| fig-cap-location: top

list(
  "Males" = fig_males_first,
  "Females" = fig_females_first
) |>
  pvd_lineplot(
    expand = 0,
    text_size = lineplot_text_size,
    events_to_highlight = c(
      "SCID: Mood Disorders: Threshold",
      "Tandem Walk: Abnormal (<10 Steps)",
      "Postural Tremor",
      "Splenium WM Hyperintensity: Mild",
      "Genu WM Hyperintensity",
      "MRI: Cerebral: Mild",
      "MRI: Cerebellar: Mild",
      "MRI: Cerebral: Moderate/Severe",
      "MRI: Cerebellar: Moderate/Severe",
      "MCP-WM Hyperintensity: Mild",
      "MCP-WM Hyperintensity: Moderate/SEver"
    ),
    highlight_color = "yellow"
  )
```

::: landscape

{{< include _sec_subtypes_bumpchart.qmd >}}

:::

# Supplementary material

{{< include _sec_supplement.qmd >}}
